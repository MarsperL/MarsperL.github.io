<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><script>(()=>{const e=navigator.serviceWorker;e?e.register("/sw.js").then(async e=>{console.log("SWPP 注册成功");try{await e.periodicSync.register("update",{minInterval:864e5})}catch(e){console.log("Periodic Sync 注册失败",e)}}).catch(e=>console.error("SWPP 注册失败",e)):console.warn("当前浏览器不支持 SW")})()</script><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>k8s知识梳理--进阶 | 云野阁</title><meta name="author" content="云野阁"><meta name="copyright" content="云野阁"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="网络Kubernetes-网络模型原则 在不使用网络地址转换(NAT)的情况下，集群中的Pod能够与任意其他Pod进行通信 在不使用网络地址转换(NAT)的情况下，在集群节点上运行的程序能与同一节点上的任何Pod进行通信 每个Pod都有自己的IP地址(IP-per-Pod)，并且任意其他Pod都可以通过相同的这个地址访问它 借助CNI标准，Kubernetes可以实现容器网络问题的解决。通过插件化"><meta property="og:type" content="article"><meta property="og:title" content="k8s知识梳理--进阶"><meta property="og:url" content="https://yyg.js.cool/yyg/986299a9/index.html"><meta property="og:site_name" content="云野阁"><meta property="og:description" content="网络Kubernetes-网络模型原则 在不使用网络地址转换(NAT)的情况下，集群中的Pod能够与任意其他Pod进行通信 在不使用网络地址转换(NAT)的情况下，在集群节点上运行的程序能与同一节点上的任何Pod进行通信 每个Pod都有自己的IP地址(IP-per-Pod)，并且任意其他Pod都可以通过相同的这个地址访问它 借助CNI标准，Kubernetes可以实现容器网络问题的解决。通过插件化"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://api.mmp.cc/api/pcwallpaper?category=cool&type=jpg"><meta property="article:published_time" content="2025-08-22T10:17:22.000Z"><meta property="article:modified_time" content="2025-08-22T14:20:41.000Z"><meta property="article:author" content="云野阁"><meta property="article:tag" content="运维"><meta property="article:tag" content="k8s"><meta property="article:tag" content="HELM"><meta property="article:tag" content="知识梳理"><meta property="article:tag" content="Linux"><meta property="article:tag" content="二进制高可用k8s集群"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://api.mmp.cc/api/pcwallpaper?category=cool&type=jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "k8s知识梳理--进阶",
  "url": "https://yyg.js.cool/yyg/986299a9/",
  "image": "https://api.mmp.cc/api/pcwallpaper?category=cool&type=jpg",
  "datePublished": "2025-08-22T10:17:22.000Z",
  "dateModified": "2025-08-22T14:20:41.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "云野阁",
      "url": "https://yyg.js.cool/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/icon.png"><link rel="canonical" href="https://yyg.js.cool/yyg/986299a9/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/img/icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/pwa/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/pwa/favicon-16x16.png"><link rel="mask-icon" href="/img/pwa/icon.svg" color="#5bbad5"><link rel="stylesheet" href="/css/index.css?v=5.5.1"><link rel="stylesheet" href="https://s4.zstatic.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css"><link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/fancyapps-ui/5.0.36/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>(()=>{const e={set:(e,t,o)=>{if(!o)return;const a=Date.now()+864e5*o;localStorage.setItem(e,JSON.stringify({value:t,expiry:a}))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const{value:o,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return o;localStorage.removeItem(e)}};window.btf={saveToLocal:e,getScript:(e,t={})=>new Promise((o,a)=>{const n=document.createElement("script");n.src=e,n.async=!0,Object.entries(t).forEach(([e,t])=>n.setAttribute(e,t)),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)}),getCSS:(e,t)=>new Promise((o,a)=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,t&&(n.id=t),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)}),addGlobalFn:(e,t,o=!1,a=window)=>{if(e.startsWith("pjax"))return;const n=a.globalFn||{};n[e]=n[e]||{},n[e][o||Object.keys(n[e]).length]=t,a.globalFn=n}};const t=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},o=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};btf.activateDarkMode=t,btf.activateLightMode=o;const a=e.get("theme"),n=(new Date).getHours();void 0===a?n<=5||n>=19?t():o():"light"===a?o():t();const r=e.get("aside-status");void 0!==r&&document.documentElement.classList.toggle("hide-aside","hide"===r);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.json",preload:!1,top_n_per_article:1,unescape:!1,pagination:{enable:!0,hitsPerPage:8},languages:{hits_empty:"未找到符合您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:200,highlightFullpage:!1,highlightMacStyle:!0},copy:{success:"复制成功",error:"复制失败",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,infinitegrid:{js:"https://s4.zstatic.net/ajax/libs/egjs-infinitegrid/4.12.0/infinitegrid.min.js",buttonText:"加载更多"},isPhotoFigcaption:!1,islazyloadPlugin:!0,isAnchor:!1,percent:{toc:!0,rightside:!0},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"k8s知识梳理--进阶",isHighlightShrink:!1,isToc:!0,pageType:"post"}</script><link rel="stylesheet" href="/css/parts.css"><link rel="stylesheet" href="/css/link.css"><script src="https://npm.elemecdn.com/echarts@5.4.3/dist/echarts.min.js"></script><script defer src="https://s4.zstatic.net/ajax/libs/sweetalert2/11.16.1/sweetalert2.all.js"></script><script defer src="/js/lunar.js"></script><script defer src="/js/day.js"></script><script defer src="/sw-dom.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload='this.media="all"'><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/rss2.xml" title="云野阁" type="application/rss+xml"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/icon.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">62</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">109</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/docs/"><i class="fa-fw fa-solid fa-book-bookmark"></i> <span>教程手册</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-blog"></i> <span>博文</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li><li><a class="site-page child" href="javascript:randomPost();"><i class="fa-fw fa-solid fa-shuffle"></i> <span>随机一篇</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book-open"></i> <span>文界</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/yygrss/"><i class="fa-fw fa-solid fa-square-rss"></i> <span>瀚文集</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fa-solid fa-comment-nodes"></i> <span>友文说</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-brands fa-get-pocket"></i> <span>蓝口袋</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/pintree/"><i class="fa-fw fa fa-search-plus"></i> <span>导航</span></a></li><li><a class="site-page child" href="/sand/"><i class="fa-fw fa fa-cube"></i> <span>繁沙</span></a></li><li><a class="site-page child" href="/trip/"><i class="fa-fw fa-solid fa-earth-asia"></i> <span>星游记</span></a></li><li><a class="site-page child" href="/share/"><i class="fa-fw fa-solid fa-star"></i> <span>书•影•音</span></a></li><li><a class="site-page child" href="/focusclock/"><i class="fa-fw fas fa-clock"></i> <span>专注时钟</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-comments"></i> <span>聊天室</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-comment-dots"></i> <span>说说</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i> <span>心语亭</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-circle-user"></i> <span>更多</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://api.mmp.cc/api/pcwallpaper?category=cool&amp;type=jpg)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://gcore.jsdelivr.net/gh/MarsperL/MarsperL.github.io@2.1/img/icon.png" alt="Logo"><span class="site-name">云野阁</span></a><a class="nav-page-title" href="/"><span class="site-name">k8s知识梳理--进阶</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i> <span>返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/docs/"><i class="fa-fw fa-solid fa-book-bookmark"></i> <span>教程手册</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-blog"></i> <span>博文</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li><li><a class="site-page child" href="javascript:randomPost();"><i class="fa-fw fa-solid fa-shuffle"></i> <span>随机一篇</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book-open"></i> <span>文界</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/yygrss/"><i class="fa-fw fa-solid fa-square-rss"></i> <span>瀚文集</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fa-solid fa-comment-nodes"></i> <span>友文说</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-brands fa-get-pocket"></i> <span>蓝口袋</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/pintree/"><i class="fa-fw fa fa-search-plus"></i> <span>导航</span></a></li><li><a class="site-page child" href="/sand/"><i class="fa-fw fa fa-cube"></i> <span>繁沙</span></a></li><li><a class="site-page child" href="/trip/"><i class="fa-fw fa-solid fa-earth-asia"></i> <span>星游记</span></a></li><li><a class="site-page child" href="/share/"><i class="fa-fw fa-solid fa-star"></i> <span>书•影•音</span></a></li><li><a class="site-page child" href="/focusclock/"><i class="fa-fw fas fa-clock"></i> <span>专注时钟</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-comments"></i> <span>聊天室</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-comment-dots"></i> <span>说说</span></a></li><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i> <span>心语亭</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-circle-user"></i> <span>更多</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">k8s知识梳理--进阶</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-08-22T10:17:22.000Z" title="发表于 2025-08-22 18:17:22">2025-08-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-22T14:20:41.000Z" title="更新于 2025-08-22 22:20:41">2025-08-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%B9%E5%99%A8%E5%8C%96/">容器化</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%A2%B3%E7%90%86%E6%80%BB%E7%BB%93/">梳理总结</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%A2%B3%E7%90%86%E6%80%BB%E7%BB%93/%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/">知识梳理</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%B9%E5%99%A8%E5%8C%96/k8s/">k8s</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%B9%E5%99%A8%E5%8C%96/HELM/">HELM</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">11.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>58分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18v44h-352Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><p>Kubernetes-网络模型原则</p><p>在不使用网络地址转换(NAT)的情况下，集群中的Pod能够与任意其他Pod进行通信</p><p>在不使用网络地址转换(NAT)的情况下，在集群节点上运行的程序能与同一节点上的任何Pod进行通信</p><p>每个Pod都有自己的IP地址(IP-per-Pod)，并且任意其他Pod都可以通过相同的这个地址访问它</p><p>借助CNI标准，Kubernetes可以实现容器网络问题的解决。通过插件化的方式来集成各种网络插件，实现集群内部网终相互通信，只要实现CNI标准中定义的核心接口操作(ADD,将容器添加到网络；DEL，从网络中删除一个容器；CHECK,检查容器的网络是否符合预期等)。CNI插件通常聚焦在容器到容器的网络通信。</p><p>CNl的接口并不是指HTTP,gRPC这种接口，CNl接口是指对可执行程序的调用(exec)可执行程序，Kubernetes节点默认的CN插件路径为/opt/cni/bin</p><p>CNI通过JSON格式的配置文件来描述网络配置，当需要设置容器网络时，由容器运行时负责执行CN!插件，并通过CNl插件的标准输入(stdi)来传递配置文件信息，通过标准输出(stdout)接收插件的执行结果。从网络插件功能可以分为五类：</p><ul><li>Main插件，创建具体网络设备(bridge:网桥设备，连接container和host；ipvlan:为容器增加ipvlan网卡；loopback:IO设备；macvlan:为容器创建一个MAC地址；ptp:创建一对VethPair；vlan:分配一个vlan设备；host-device:将已存在的设备移入容器内)</li><li>IPAM插件：负责分配IP地址(dhcp:容器向DHCP服务器发起请求，给Pod发放或回收P地址；host-local:使用预先配置的IP地址段来进行分配；static:为容器分配一个静态IPv4/IPv6地址主要用于debug)</li><li>META插件：其他功能的插件(tuning:通过sysctl调整网络设备参数；portmap:通过iptables配置端口映射；bandwidth:使用Token Bucket Filter来限流；sbr:为网卡设置source based routing；firewall：通过iptables给容器网络的进出流量进行限制)</li><li>Windows插件：专门用于Windows平台的CNl插件(win-bridge与win-overlay网络插件)</li><li>第三方网络插件：第三方开源的网络插件众多，每个组件都有各自的优点及适应的场景，难以形成统一的标准组件，常用有Flannel、Calico、Cilium、OVN网络插件</li></ul><div class="table-container"><table><thead><tr><th>提供商</th><th>网络模型</th><th>路由分发</th><th>网络策略</th><th>网格</th><th>外部数据存储</th><th>加密</th><th>Ingress/Egress策略</th></tr></thead><tbody><tr><td>Canal</td><td>封装（VXLAN）</td><td>否</td><td>是</td><td>否</td><td>k8s API</td><td>是</td><td>是</td></tr><tr><td>Flannel</td><td>封装（VXLAN）</td><td>否</td><td>否</td><td>否</td><td>k8s API</td><td>是</td><td>否</td></tr><tr><td>Calico</td><td>封装（VXLAN, IPIP）或未封装</td><td>是</td><td>是</td><td>是</td><td>Etcd和k8s API</td><td>是</td><td>是</td></tr><tr><td>Weave</td><td>封装</td><td>是</td><td>是</td><td>是</td><td>否</td><td>是</td><td>是</td></tr><tr><td>Cilium</td><td>封装（VXLAN）</td><td>是</td><td>是</td><td>是</td><td>Etcd和k8s API</td><td>是</td><td>是</td></tr></tbody></table></div><blockquote><ul><li>网络模型：封装或未封装。</li><li>路由分发：一种外部网关协议，用于在互联网上交换路由和可达性信息。BGP可以帮助进行跨集群ρod之间的网络。此功能对于未封装的CNI网络插件是必须的，并且通常由BGP完成。如果你想构建跨网段拆分的集群，路由分发是一个很好的功能。</li><li>网络策略：Kubernetes提供了强制执行规则的功能，这些规则决定了哪些service可以使用网络策略进行相互通信。这是从Kubernetes1.7起稳定的功能，可以与某些网络插件一起使用。</li><li>网格：允许在不同的Kubernetes集群间进行service之间的网络通信。</li><li>外部数据存储：具有此功能的C!网络插件需要一个外部数据存储来存储数据。</li><li>加密：允许加密和安全的网络控制和数据平面。</li><li>Ingress/Egress策略：允许你管理Kubernetes和非Kubernetes通信的路由控制。</li></ul></blockquote><p>Calico是一个纯三层的虚拟网络，它没有复用docker的docker0网桥，而是自己实现的，calico网络不对数据包进行额外封装，不需要NAT和端口映射</p><p><strong>Calico架构</strong>：</p><p><strong>Felix</strong></p><ul><li>管理网络接口编写路由</li><li>编写ACL</li><li>报告状态</li></ul><p><strong>bird (BGP Client)</strong></p><p>BGP Client将通过BGP协议广播告诉剩余calico节点，从而实现网络互通</p><p><strong>confd</strong></p><p>通过监听etcd以了解BGP配置和全局默认值的更改。Confd根据ETCD虫数据的更新，动态生成BRD配置文件文件更改时confd触发BlRD重新加载</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/yyg/986299a9/1.png" title="img"><p><strong>Calico网络模式—VXLAN</strong>：</p><blockquote><p>什么是VXLAN?</p><ul><li><p>VXLAN,即Virtual Extensible LAN(虚拟可扩展局域网)，是Linux本身支持的一网种网络虚拟化技术。VXLAN可以完全在内核态实现封装和解封装工作，从而通过“隧道”机制，构建出覆盖网络(Overlay Network)</p></li><li><p>基于三层的”二层“通信，层即vxlan包封装在udp数据包中，要求udp在k8s节点间三层可达；二层即vxlan封包的源mac地址和目的mac地址是自己的vxlan设备mac和对端vxlan设备mac实现通讯。</p></li></ul></blockquote><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/yyg/986299a9/2.png" title="img"><blockquote><p>数据包封包：封包，在vxlan设备上将pod发来的数据包源、目的mac替换为本机vxlan网卡和对端节点vxlan网卡的mac。外层udp目的ip地址根据路由和对端vxlan的mac fdb表获取</p><p>优势：只要k8s节点间三层互通，可以跨网段，对主机网关路由没有特殊要求。各个node节点通过vxlan设备实现基于三层的”二层”互通，三层即vxlan包封装在udp数据包中，要求udp在k8s节点间三层可达；二层即vxlan封包的源mac地址和目的mac地址是自己的vxlan设备mac和对端vxlan设备mac</p><p>缺点：需要进行vxan的数据包封包和解包会存在一定的性能损耗</p></blockquote><p>Calico配置开启VXLAN</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Enable IPIP</span></span><br><span class="line"><span class="string">-name:CALICO</span> <span class="string">IPV4POOL</span> <span class="string">IPIP</span></span><br><span class="line"><span class="string">-value:&quot;Never&quot;</span></span><br><span class="line"><span class="comment">#Enable or Disable VXLAN on the default IP pool.</span></span><br><span class="line"><span class="string">-name:CALICO</span> <span class="string">IPV4POOL</span> <span class="string">VXLAN</span></span><br><span class="line"><span class="string">-value:&quot;Always&quot;</span></span><br><span class="line"><span class="comment">#Enable or Disable VXLAN on the default IPv6 IP pool.</span></span><br><span class="line"><span class="string">-name:CALICO</span> <span class="string">IPV6POOL</span> <span class="string">VXLAN</span></span><br><span class="line"><span class="string">-value:&quot;Always&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#calico_backend:&quot;bird&quot;</span></span><br><span class="line"><span class="string">calico_backend:&quot;vxlan&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注释存活探测和就绪探测</span></span><br><span class="line"><span class="comment">#--bird-live</span></span><br><span class="line"><span class="comment">#--bird-ready</span></span><br></pre></td></tr></table></figure><p><strong>Calico网络模式—IPIP</strong>：</p><blockquote><p>Linux原生内核支持</p><p>IPIP隧道的工作原理是将源主机的IP数据包封装在一个新的P数据包中，新的IP数据包的目的地址是隧道的另一端。在隧道的另一端，接收方将解封装原始IP数据包，并将其传递到目标主机。IPIP隧道可以在不同的网络之间建立连接，例如在IPV4网络和IPV6网络之间建立连接。</p><p>数据包封包：封包，在tunl0设备上将pod发来的数据包的mac层去掉，留下ip层封包。<br>外层数据包目的ip地址根据路由得到。<br>优点：只要k8s节点间三层互通，可以跨网段，对主机网关路由没有特殊要求。<br>缺点：需要进行IPIP的数据包封包和解包会存在一定的性能损耗</p></blockquote><p>Calico配置开启IPIP</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Enable IPIP</span></span><br><span class="line"><span class="string">-name:CALICO</span> <span class="string">IPV4POOL</span> <span class="string">IPIP</span></span><br><span class="line"><span class="string">-value:&quot;Always&quot;</span></span><br><span class="line"><span class="comment">#Enable or Disable VXLAN on the default IP pool.</span></span><br><span class="line"><span class="string">-name:CALICO</span> <span class="string">IPV4POOL</span> <span class="string">VXLAN</span></span><br><span class="line"><span class="string">-value:&quot;Never&quot;</span></span><br><span class="line"><span class="comment">#Enable or Disable VXLAN on the default IPv6 IP pool.</span></span><br><span class="line"><span class="string">-name:CALICO</span> <span class="string">IPV6POOL</span> <span class="string">VXLAN</span></span><br><span class="line"><span class="string">-value:&quot;Never&quot;</span></span><br></pre></td></tr></table></figure><p><strong>Calico网络模式—BGP</strong>：</p><blockquote><p>边界网关协议(Border Gateway Protocol,.BGP)是互联网上一个核心的去中心化自治路由协议。它通过维护IP路由表或‘前缀’表来实现自治系统(AS)之间的可达性，属于量路由协议。BGP不使用传统的内部网关协议(IGP)的指标，而使用基于路径、网络策略或规则集来决定路由。因此，它更适合被称为矢量性协议，而不是路由协议。BGP，通俗的讲就是讲接入到机房的多条线路（如电信、联通，移动等）融合为一体，实现多线单IP,BGP机房的优点：服务器只需要设置一个IP地址，最佳访问路由是由网络上的骨干路由器根据路由跳数与其它技术指标来确定的，不会占用服务器的任何系统。</p><p>数据包封包：不需要进行数据包封包</p><p>优点：不用封包解包，通过BGP协议可实现pod网络在主机间的三层可达</p><p>缺点：跨网段时，配置较为复杂网络要求较高，主机网关路由也需要充当BGP Speaker。.</p></blockquote><p>Calico配置开启BGP</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Enable IPIP</span></span><br><span class="line"><span class="string">-name:CALICO</span> <span class="string">IPV4POOL</span> <span class="string">IPIP</span></span><br><span class="line"><span class="string">-value:&quot;Off&quot;</span></span><br><span class="line"><span class="comment">#Enable or Disable VXLAN on the default IP pool.</span></span><br><span class="line"><span class="string">-name:CALICO</span> <span class="string">IPV4POOL</span> <span class="string">VXLAN</span></span><br><span class="line"><span class="string">-value:&quot;Never&quot;</span></span><br><span class="line"><span class="comment">#Enable or Disable VXLAN on the default IPv6 IP pool.</span></span><br><span class="line"><span class="string">-name:CALICO</span> <span class="string">IPV6POOL</span> <span class="string">VXLAN</span></span><br><span class="line"><span class="string">-value:&quot;Never&quot;</span></span><br></pre></td></tr></table></figure><h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>在Kubernetes集群中，每个Node运行一个<code>kube-proy</code>进程。<code>kube-proxy</code>负责为Service实现了一种VIP(虚拟IP)的形式。</p><p>在Kubernetes v1.0版本，代理完全在userspace。在Kubernetes v1.1版本，新增了iptables代理，但并不是默认的运行模式。从Kubernetes v1.2起，默认就是iptables代理。在Kubernetes v1.8.0-beta.0中，添加了ipvs代理。</p><p><strong>userspace</strong></p><p>kube-proxy：</p><ul><li>监听APISERVER将Service的变化修改本地的iptables规则</li><li>代理当前节点的pod用户请求</li></ul><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/yyg/986299a9/3.png" title="img"><p><strong>Iptables</strong></p><p>kube-proxy：</p><ul><li>监听APISERVER将Service的变化修改本地的iptables规则</li></ul><p>相对于userspace方式，kube-proxy功能解耦压力更小</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/yyg/986299a9/4.png" title="img"><p><strong>ipvs</strong></p><p>kube-proxy：</p><ul><li>监听APISERVER将Service的变化修改本地的ipvs规则</li></ul><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/yyg/986299a9/5.png" title="img"><h2 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h2><p>Kubernetes通过仅仅将Secret分发到需要访问Secret的Pod所在的机器节点来保障其安全性。Secret只会存储在节点的内存中，永不写入物理存储，这样从节点删除secret时就不需要擦除磁盘数据。</p><p>从Kubernetes1.7版本开始，etcd会以加密形式存储Secret,.一定程度的保证了Secret安全性。</p><p><strong>Secret类型</strong>：</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/yyg/986299a9/6.png" title="image-20250710174515895"><h2 id="Downward-API"><a href="#Downward-API" class="headerlink" title="Downward API"></a>Downward API</h2><p>Downward API是Kubernetes中的一个功能，它允许容器在运行时从Kubernetes API服务器获取有关它们自身的信息。这些信息可以作为容器内部的环境变量或文件注入到容器中，以便容器可以获取有关其运行环境的各种信息，如Pod名称、命名空间、标签等</p><ul><li>提供容器元数据</li><li>动态配置</li><li>与Kubernetes环境集成</li></ul><h2 id="HELM"><a href="#HELM" class="headerlink" title="HELM"></a>HELM</h2><p>Helm是官方提供的类似于YUM的包管理器，是部署环境的流程封装。Helm有两个重要的慨念：chart和release</p><ul><li>Chart：是创建一个应用的信息集合，包括各种Kubernetes对象的配置模板、参数定义、依赖关系、文档说明等。chart是应用部署的自包含逻辑单元。可以将chart想象成apt、yum中的软件安装包</li><li>Release：是chart的运行实例，代表了一个正在运行的应用。当chart被安装到Kubernetes集群，就生成一个release。chart能够多次安装到同一个集群，每次安装都是一个release。</li><li>Hlelm cli：helm客户端组件，负责和kubernetes apiserver通信</li><li>Repository：用于发布和存储Chart的仓库</li></ul><h3 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h3><p>下载Helm</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://get.helm.sh/helm-v3.18.4-linux-amd64.tar.gz</span><br><span class="line">tar -zxvf helm-v3.18.4-linux-amd64.tar.gz</span><br><span class="line">cp -a linux-amd64/helm /usr/local/bin/</span><br><span class="line">chmod a+x /usr/local/bin/helm</span><br><span class="line">helm version</span><br></pre></td></tr></table></figure><p>添加chart仓库国内源</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm repo add bitnami https://helm-charts.itboon.top/bitnami --force-update</span><br><span class="line">helm repo update</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">搜索仓库内容</span></span><br><span class="line">helm search repo bitnami</span><br></pre></td></tr></table></figure><h3 id="安装chart示例"><a href="#安装chart示例" class="headerlink" title="安装chart示例"></a>安装chart示例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看apache包配置</span></span><br><span class="line">helm show values bitnami/apache</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装apache</span></span><br><span class="line">helm install bitnami/apache --generate-name</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看</span></span><br><span class="line">helm list -n default</span><br><span class="line">kubectl get svc</span><br><span class="line">kubectl get pod</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看chart基本信息</span></span><br><span class="line">helm show chart bitnami/apache</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看chart所有信息</span></span><br><span class="line">helm show all bitnami/apache</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">删除版本</span></span><br><span class="line">helm uninstall apache-1753181984</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">保留历史版本</span></span><br><span class="line">helm uninstall apache-1753181984 --keep-history</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看该版本的信息</span></span><br><span class="line">helm status apache-1753182488</span><br></pre></td></tr></table></figure><p>拓展</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在当前仓库中搜索wordpress的cahrt包</span></span><br><span class="line">helm search repo wordpress</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在官方仓库中搜索wordpress的cahrt包</span></span><br><span class="line">helm search hub wordpress</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装apache并指定名称为apache-1753234488</span></span><br><span class="line">helm install apache-1753234488 bitnami/apache </span><br></pre></td></tr></table></figure><p>安装自定义chart</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看apache包配置</span></span><br><span class="line">helm show values bitnami/apache</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建yaml文件，添加要修改的参数</span></span><br><span class="line">vi apache.yml</span><br><span class="line">service:</span><br><span class="line">  type: NodePort</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">覆盖配置参数，并安装apache</span></span><br><span class="line">helm install -f apache.yml bitnami/apache --generate-name</span><br></pre></td></tr></table></figure><p>除了使用yaml文件覆盖外，还可以使用<code>--set：</code>通过命令行的方式对指定项进行覆盖。如果同时使用两种方式，则<code>--set</code>中的值会被合并到<code>--values</code>中，但是<code>--set</code>中的值优先级更高，在<code>--set</code>中覆盖的内容会被被保存在ConfigMap中。可以通过<code>helm get values &lt;release-name&gt;</code>来查看指定release中<code>--set</code>设置的值。也可以通过运行<code>helm upgrade</code>并指定<code>--reset-values</code>字段来清除<code>--set</code>中设置的值。</p><p><code>--set</code>的格式和限制</p><p><code>--set</code>选项使用0或多个name/value对。最简单的用法类似于：<code>--set name=value</code>,等价于如下YAML格式：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">name:value</span></span><br></pre></td></tr></table></figure><p>多个值使用逗号分割，因此<code>--set a=b,c=d</code>的YAML表示是：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">a:</span> <span class="string">b</span></span><br><span class="line"><span class="attr">c:</span> <span class="string">d</span></span><br></pre></td></tr></table></figure><p>支持更复杂的表达式。例如，<code>--set outer.inner=value</code>被转换成了：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">outer:</span><br><span class="line">  inner: value</span><br></pre></td></tr></table></figure><p>列表使用花括号(<code>&#123;&#125;</code>)来表示，例如，<code>--set name=&#123;a,b,c&#125;</code>被转换成了：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span></span><br><span class="line">  <span class="string">-a</span></span><br><span class="line">  <span class="string">-b</span></span><br><span class="line">  <span class="string">-c</span></span><br></pre></td></tr></table></figure><p>某些name/key可以设置为null或者空数组，例如<code>--set name=[],a=null</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> []</span><br><span class="line"><span class="attr">a:</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure><h3 id="升级和回滚"><a href="#升级和回滚" class="headerlink" title="升级和回滚"></a>升级和回滚</h3><p><code>helm upgrade</code>执行最小侵入式升级，只更新上次发布以来发生更改的内容。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">helm upgrade -f yaml文件 版本名 chart包</span></span><br><span class="line">helm upgrade -f apache.yml apache-1753183272 bitnami/apache</span><br></pre></td></tr></table></figure><p>版本回滚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看存在的版本</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">helm <span class="built_in">history</span> 版本名</span></span><br><span class="line">helm history apache-1753183272</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">执行回滚</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">helm rollback 版本名 版本号</span></span><br><span class="line">helm rollback apache-1753183272 1</span><br></pre></td></tr></table></figure><h3 id="创建自定义chart包"><a href="#创建自定义chart包" class="headerlink" title="创建自定义chart包"></a>创建自定义chart包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建chart包</span></span><br><span class="line">helm create test</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">删除不需要的文件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在templates中创建yaml资源清单</span></span><br><span class="line">vi nodePort.yaml</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###########################</span></span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-test-202401110926-svc</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp-test</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: myapp-test</span><br><span class="line">  ports:</span><br><span class="line">    - name: &quot;80-80&quot;</span><br><span class="line">      protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line">      nodePort: 31111</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###########################</span></span></span><br><span class="line">vi deplyment.yaml</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###########################</span></span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-test-202401110926-deploy</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp-test</span><br><span class="line">spec:</span><br><span class="line">  replicas: 5</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: myapp-test</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: myapp-test</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: myapp</span><br><span class="line">          image: wangyanglinux/myapp:v1.0</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###########################</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">发布部署</span></span><br><span class="line">helm install test test/</span><br></pre></td></tr></table></figure><p>完整示例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">vi templates/NOTES.txt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###########################</span></span></span><br><span class="line">1. 这是一个测试的 myapp chart</span><br><span class="line">2. myapp release 名字：myapp-test-&#123;&#123; now | date &quot;20060102030405&quot; &#125;&#125;-deploy</span><br><span class="line">3. service 名字：myapp-test-&#123;&#123; now | date &quot;20060102030405&quot; &#125;&#125;-svc</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###########################</span></span></span><br><span class="line">vi templates/deplyment.yaml</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###########################</span></span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-test-&#123;&#123; now | date &quot;20060102030405&quot; &#125;&#125;-deploy</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp-test</span><br><span class="line">spec:</span><br><span class="line">  replicas: &#123;&#123; .Values.replicaCount &#125;&#125;</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: myapp-test</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: myapp-test</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: myapp</span><br><span class="line">          image: &quot;&#123;&#123; .Values.image.repository &#125;&#125;:&#123;&#123; .Values.image.tag &#125;&#125;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###########################</span></span></span><br><span class="line">vi templates/service.yaml</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###########################</span></span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-test-&#123;&#123; now | date &quot;20060102030405&quot; &#125;&#125;-svc</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp-test</span><br><span class="line">spec:</span><br><span class="line">  type: &#123;&#123; .Values.service.type | quote &#125;&#125;</span><br><span class="line">  selector:</span><br><span class="line">    app: myapp-test</span><br><span class="line">  ports:</span><br><span class="line">    - name: &quot;80-80&quot;</span><br><span class="line">      protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line">      &#123;&#123;- if eq .Values.service.type &quot;NodePort&quot; &#125;&#125;</span><br><span class="line">      nodePort: &#123;&#123; .Values.service.nodePort &#125;&#125;</span><br><span class="line">      &#123;&#123;- end &#125;&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###########################</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">与templates目录同一级</span></span><br><span class="line">vi values.yaml</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###########################</span></span></span><br><span class="line">replicaCount: 5</span><br><span class="line">image:</span><br><span class="line">  repository: wangyanglinux/myapp</span><br><span class="line">  tag: &quot;v1.0&quot;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">service:</span><br><span class="line">  type: NodePort</span><br><span class="line">  nodePort: 32321  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###########################</span></span></span><br></pre></td></tr></table></figure><h2 id="二进制高可用Kubernetes集群部署"><a href="#二进制高可用Kubernetes集群部署" class="headerlink" title="二进制高可用Kubernetes集群部署"></a>二进制高可用Kubernetes集群部署</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>通过5台服务器使用二进制方式部署采用三主两从的高可用Kubernetes集群。</p><h3 id="集群架构"><a href="#集群架构" class="headerlink" title="集群架构"></a>集群架构</h3><p>（1）基础环境</p><p>操作系统：Rocky Linux release 10.0</p><p>软件：Kubernetes-1.33.4、docker-28.3.3</p><p>（2）环境准备</p><div class="table-container"><table><thead><tr><th>主机名</th><th>IP</th><th>集群及组件角色</th></tr></thead><tbody><tr><td>k8s-master01</td><td>192.168.0.111</td><td>master，api-server，control manager，scheduler，etcd，<br>kubelet，kube-proxy，nginx</td></tr><tr><td>k8s-master02</td><td>192.168.0.112</td><td>master，api-server，control manager，scheduler，etcd，<br>kubelet，kube-proxy，nginx</td></tr><tr><td>k8s-master03</td><td>192.168.0.113</td><td>master，api-server，control manager，scheduler，etcd，<br>kubelet，kube-proxy，nginx</td></tr><tr><td>k8s-node01</td><td>192.168.0.114</td><td>worker，kubelet，kube-proxy，nginx</td></tr><tr><td>k8s-node02</td><td>192.168.0.115</td><td>worker，kubelet，kube-proxy，nginx</td></tr></tbody></table></div><h3 id="环境初始化"><a href="#环境初始化" class="headerlink" title="环境初始化"></a>环境初始化</h3><p>（1）更换系统软件源，下载依赖软件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sed -e &#x27;s|^mirrorlist=|#mirrorlist=|g&#x27; \</span><br><span class="line">    -e &#x27;s|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g&#x27; \</span><br><span class="line">    -i.bak \</span><br><span class="line">    /etc/yum.repos.d/[Rr]ocky*.repo</span><br><span class="line"></span><br><span class="line">dnf makecache</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载依赖软件</span></span><br><span class="line">yum install -y wget openssl gcc gcc-c++ zlib-devel openssl-devel make redhat-rpm-config</span><br></pre></td></tr></table></figure><p>（2）重命名hostname</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-master01 &amp;&amp; bash</span><br><span class="line">hostnamectl set-hostname k8s-master02 &amp;&amp; bash</span><br><span class="line">hostnamectl set-hostname k8s-node01 &amp;&amp; bash</span><br><span class="line">hostnamectl set-hostname k8s-node02 &amp;&amp; bash</span><br><span class="line">hostnamectl set-hostname k8s-node03 &amp;&amp; bash</span><br></pre></td></tr></table></figure><p>（3）系统环境修改</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关闭firewalld防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">firewall-cmd --state</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装iptables</span></span><br><span class="line">yum install -y iptables-services</span><br><span class="line">systemctl start iptables</span><br><span class="line">iptables -F</span><br><span class="line">systemctl enable iptables</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">selinux永久关闭</span></span><br><span class="line">setenforce 0</span><br><span class="line"> sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=disabled/&#x27; /etc/selinux/config</span><br><span class="line">cat /etc/selinux/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">swap永久关闭</span></span><br><span class="line">swapoff -a</span><br><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br><span class="line">cat /etc/fstab</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置时区</span></span><br><span class="line">timedatectl set-timezone Asia/Shanghai</span><br><span class="line">date</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加hosts</span></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.0.111 k8s-master01</span><br><span class="line">192.168.0.112 k8s-master02</span><br><span class="line">192.168.0.113 k8s-master03</span><br><span class="line">192.168.0.114 k8s-node01</span><br><span class="line">192.168.0.115 k8s-node02</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看</span></span><br><span class="line">cat /etc/hosts</span><br></pre></td></tr></table></figure><p>（4）安装ipvs</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装ipvs</span></span><br><span class="line">yum -y install ipvsadm sysstat conntrack libseccomp</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启路由转发</span></span><br><span class="line">echo &#x27;net.ipv4.ip_forward=1&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ipvs加载模块</span></span><br><span class="line">cat &gt;&gt; /etc/modules-load.d/ipvs.conf &lt;&lt;EOF</span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br><span class="line">ip_tables</span><br><span class="line">ip_set</span><br><span class="line">xt_set</span><br><span class="line">ipt_set</span><br><span class="line">ipt_rpfilter</span><br><span class="line">ipt_REJECT</span><br><span class="line">ipip</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart systemd-modules-load.service</span><br><span class="line"></span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack</span><br></pre></td></tr></table></figure><p>（5）排除 calico 网卡被 NetworkManager 所管理</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">排除 calico 网卡被 NetworkManager 所管理</span></span><br><span class="line">cat &gt; /etc/NetworkManager/conf.d/calico.conf &lt;&lt; EOF </span><br><span class="line">[keyfile]</span><br><span class="line">unmanaged-devices=interface-name:cali*;interface-name:tunl*</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart NetworkManager</span><br></pre></td></tr></table></figure><p>（6）配置时间同步服务器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改k8s-master01上的chrony配置文件</span></span><br><span class="line">sed -i -e &#x27;s/2\.rocky\.pool\.ntp\.org/ntp.aliyun.com/g&#x27; -e &#x27;s/#allow 192\.168\.0\.0\/16/allow 192.168.0.0\/24/g&#x27; -e &#x27;s/#local stratum 10/local stratum 10/g&#x27; /etc/chrony.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改k8s-master02上的chrony配置文件</span></span><br><span class="line">sed -i -e &#x27;s/2\.rocky\.pool\.ntp\.org/ntp.aliyun.com/g&#x27; -e &#x27;s/#allow 192\.168\.0\.0\/16/allow 192.168.0.0\/24/g&#x27; -e &#x27;s/#local stratum 10/local stratum 11/g&#x27; /etc/chrony.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改k8s-master03上的chrony配置文件</span></span><br><span class="line">sed -i -e &#x27;s/2\.rocky\.pool\.ntp\.org/ntp.aliyun.com/g&#x27; -e &#x27;s/#allow 192\.168\.0\.0\/16/allow 192.168.0.0\/24/g&#x27; -e &#x27;s/#local stratum 10/local stratum 12/g&#x27; /etc/chrony.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改k8s-node01、k8s-node02、k8s-node03上的chrony配置文件</span></span><br><span class="line">sed -i &#x27;s/^pool 2\.rocky\.pool\.ntp\.org iburst$/pool 192.168.0.111 iburst\</span><br><span class="line">pool 192.168.0.112 iburst\</span><br><span class="line">pool 192.168.0.113 iburst/g&#x27; /etc/chrony.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重启chronyd</span></span><br><span class="line">systemctl restart chronyd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">验证</span></span><br><span class="line">chronyc sources -v</span><br></pre></td></tr></table></figure><p>（7）设置进程可打开的最大文件数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置 <span class="built_in">ulimit</span></span></span><br><span class="line">ulimit -SHn 65535</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/security/limits.conf &lt;&lt; EOF</span><br><span class="line">* soft nofile 655360</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft nproc 655350</span><br><span class="line">* hard nproc 655350</span><br><span class="line">* soft memlock unlimited</span><br><span class="line">* hard memlock unlimitedd</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>（8）修改内核参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_watches=89100</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">net.ipv4.tcp_keepalive_time = 600</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.tcp_keepalive_intvl =15</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 36000</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_max_orphans = 327680</span><br><span class="line">net.ipv4.tcp_orphan_retries = 3</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line">net.ipv4.ip_conntrack_max = 65536</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line">net.ipv4.tcp_timestamps = 0</span><br><span class="line">net.core.somaxconn = 16384</span><br><span class="line">net.ipv6.conf.all.disable_ipv6 = 0</span><br><span class="line">net.ipv6.conf.default.disable_ipv6 = 0</span><br><span class="line">net.ipv6.conf.lo.disable_ipv6 = 0</span><br><span class="line">net.ipv6.conf.all.forwarding = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure><h3 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h3><p>（1）使用脚本安装docker</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -sSL https://linuxmirrors.cn/docker.sh)</span><br></pre></td></tr></table></figure><p>（2）Docker配置修改</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;registry-mirrors&quot;: [</span><br><span class="line">   &quot;http://hub-mirror.c.163.com&quot;,</span><br><span class="line">   &quot;https://hub.rat.dev&quot;,</span><br><span class="line">   &quot;https://docker.mirrors.ustc.edu.cn&quot;,</span><br><span class="line">   &quot;https://docker.1panel.live&quot;,</span><br><span class="line">   &quot;https://docker.m.daocloud.io&quot;,</span><br><span class="line">   &quot;https://docker.1ms.run&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;max-concurrent-downloads&quot;: 10,</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-level&quot;: &quot;warn&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;10m&quot;,</span><br><span class="line">    &quot;max-file&quot;: &quot;3&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">  &quot;data-root&quot;: &quot;/data/dockerData&quot;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><h3 id="安装cri-dockerd"><a href="#安装cri-dockerd" class="headerlink" title="安装cri-dockerd"></a>安装cri-dockerd</h3><p>（1）下载安装cri-dockerd</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.18/cri-dockerd-0.3.18.amd64.tgz</span><br><span class="line"></span><br><span class="line">tar xvf cri-dockerd-*.amd64.tgz </span><br><span class="line">cp -r cri-dockerd/*  /usr/bin/</span><br><span class="line">chmod +x /usr/bin/cri-dockerd</span><br></pre></td></tr></table></figure><p>（2）添加cri-docker服务配置文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  /usr/lib/systemd/system/cri-docker.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=CRI Interface for Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.mirantis.com</span><br><span class="line">After=network-online.target firewalld.service docker.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=cri-docker.socket</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/cri-dockerd --network-plugin=cni --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.10</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TasksMax=infinity</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>（3）添加cri-docker的socket配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/cri-docker.socket &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=CRI Docker Socket for the API</span><br><span class="line">PartOf=cri-docker.service</span><br><span class="line"></span><br><span class="line">[Socket]</span><br><span class="line">ListenStream=%t/cri-dockerd.sock</span><br><span class="line">SocketMode=0660</span><br><span class="line">SocketUser=root</span><br><span class="line">SocketGroup=docker</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=sockets.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>（4）启动cri-dockerd，使得配置生效</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now cri-docker.service</span><br><span class="line">systemctl status cri-docker.service</span><br></pre></td></tr></table></figure><h3 id="安装etcd集群（master节点）"><a href="#安装etcd集群（master节点）" class="headerlink" title="安装etcd集群（master节点）"></a>安装etcd集群（master节点）</h3><p>（1）下载etcd包并安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.6.4/etcd-v3.6.4-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">tar -xf etcd-*.tar.gz</span><br><span class="line">mv etcd-*/etcd /usr/local/bin/ &amp;&amp; mv etcd-*/etcdctl /usr/local/bin/</span><br><span class="line">ls /usr/local/bin/</span><br><span class="line">etcdctl version</span><br></pre></td></tr></table></figure><h3 id="安装Kubernetes集群"><a href="#安装Kubernetes集群" class="headerlink" title="安装Kubernetes集群"></a>安装Kubernetes集群</h3><p>（1）下载Kubernetes二进制包并安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.k8s.io/v1.33.2/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在master节点执行</span></span><br><span class="line">tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在node节点执行</span></span><br><span class="line">tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube&#123;let,-proxy&#125;</span><br><span class="line"></span><br><span class="line">ls /usr/local/bin/</span><br><span class="line">kubelet --version</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">所有节点执行，存放cni插件</span></span><br><span class="line">mkdir -p /opt/cni/bin</span><br></pre></td></tr></table></figure><h3 id="生成相关证书（master节点）"><a href="#生成相关证书（master节点）" class="headerlink" title="生成相关证书（master节点）"></a>生成相关证书（master节点）</h3><h4 id="安装cfssl证书管理工具"><a href="#安装cfssl证书管理工具" class="headerlink" title="安装cfssl证书管理工具"></a>安装cfssl证书管理工具</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://hub.gitmirror.com/https://github.com/cloudflare/cfssl/releases/download/v1.6.5/cfssl-certinfo_1.6.5_linux_amd64 -O /usr/local/bin/cfssl-certinfo</span><br><span class="line">wget https://hub.gitmirror.com/https://github.com/cloudflare/cfssl/releases/download/v1.6.5/cfssljson_1.6.5_linux_amd64 -O /usr/local/bin/cfssljson</span><br><span class="line">wget https://hub.gitmirror.com/https://github.com/cloudflare/cfssl/releases/download/v1.6.5/cfssl_1.6.5_linux_amd64 -O /usr/local/bin/cfssl -O /usr/local/bin/cfssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加可执行权限，查看版本</span></span><br><span class="line">chmod +x /usr/local/bin/cfssl*</span><br><span class="line">cfssl version</span><br></pre></td></tr></table></figure><h4 id="生成ETCD证书"><a href="#生成ETCD证书" class="headerlink" title="生成ETCD证书"></a>生成ETCD证书</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/etcd/ssl &amp;&amp; cd /etc/etcd/ssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建生成证书的配置文件</span></span><br><span class="line">cat &gt; ca-config.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">        &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建证书签发请求文件</span></span><br><span class="line">cat &gt; etcd-ca-csr.json  &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;etcd&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Etcd Security&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;ca&quot;: &#123;</span><br><span class="line">    &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>签发ETCD的CA证书和密钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca</span><br></pre></td></tr></table></figure><p>创建用于生成ETCD的服务端证书的配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd-csr.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;etcd&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Etcd Security&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>签发ETCD的服务端证书</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert    -ca=/etc/etcd/ssl/etcd-ca.pem    -ca-key=/etc/etcd/ssl/etcd-ca-key.pem    -config=ca-config.json -hostname=127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.0.111,192.168.0.112,192.168.0.113  -profile=kubernetes    etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd</span><br></pre></td></tr></table></figure><h4 id="生成Kubernetes证书"><a href="#生成Kubernetes证书" class="headerlink" title="生成Kubernetes证书"></a>生成Kubernetes证书</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/kubernetes/pki &amp;&amp; cd /etc/kubernetes/pki</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建证书签发请求文件</span></span><br><span class="line">cat &gt; ca-csr.json   &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;ca&quot;: &#123;</span><br><span class="line">    &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>签发Kubernetes的CA证书和密钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca</span><br></pre></td></tr></table></figure><h4 id="生成ApiServer证书"><a href="#生成ApiServer证书" class="headerlink" title="生成ApiServer证书"></a>生成ApiServer证书</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建证书签发请求文件</span></span><br><span class="line">cat &gt; apiserver-csr.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kube-apiserver&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建生成证书的配置文件</span></span><br><span class="line">cat &gt; ca-config.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">        &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>签发ApiServer的CA证书和密钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert   -ca=/etc/kubernetes/pki/ca.pem -ca-key=/etc/kubernetes/pki/ca-key.pem  -config=ca-config.json -hostname=10.96.0.1,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.0.111,192.168.0.112,192.168.0.113,192.168.0.114,192.168.0.115,192.168.0.116,192.168.0.117,192.168.0.118,192.168.0.119,192.168.0.120  -profile=kubernetes   apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver</span><br></pre></td></tr></table></figure><blockquote><p>10.96.0.1是Kubernetes的service的默认地址</p><p>kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local是Kubernetes的默认解析域名</p></blockquote><h4 id="生成ApiServer聚合证书"><a href="#生成ApiServer聚合证书" class="headerlink" title="生成ApiServer聚合证书"></a>生成ApiServer聚合证书</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建证书签发请求文件</span></span><br><span class="line">cat &gt; front-proxy-ca-csr.json  &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">     &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;ca&quot;: &#123;</span><br><span class="line">    &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>签发ApiServer聚合证书和密钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca </span><br></pre></td></tr></table></figure><h4 id="生成ApiServer聚合证书的客户端证书"><a href="#生成ApiServer聚合证书的客户端证书" class="headerlink" title="生成ApiServer聚合证书的客户端证书"></a>生成ApiServer聚合证书的客户端证书</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建证书签发请求文件</span></span><br><span class="line">cat &gt; front-proxy-client-csr.json  &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;front-proxy-client&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">     &quot;size&quot;: 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>签发ApiServer聚合证书的客户端证书和密钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert  \</span><br><span class="line">-ca=/etc/kubernetes/pki/front-proxy-ca.pem   \</span><br><span class="line">-ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem   \</span><br><span class="line">-config=ca-config.json   \</span><br><span class="line">-profile=kubernetes   front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client</span><br></pre></td></tr></table></figure><h4 id="生成controller-manager证书"><a href="#生成controller-manager证书" class="headerlink" title="生成controller-manager证书"></a>生成controller-manager证书</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建证书签发请求文件</span></span><br><span class="line">cat &gt; manager-csr.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>签发controller-manager证书和密钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager</span><br></pre></td></tr></table></figure><p>生成controller-manager专用的 kubeconfig 配置文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">     --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">     --embed-certs=true \</span><br><span class="line">     --server=https://127.0.0.1:8443 \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context system:kube-controller-manager@kubernetes \</span><br><span class="line">    --cluster=kubernetes \</span><br><span class="line">    --user=system:kube-controller-manager \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials system:kube-controller-manager \</span><br><span class="line">    --client-certificate=/etc/kubernetes/pki/controller-manager.pem \</span><br><span class="line">    --client-key=/etc/kubernetes/pki/controller-manager-key.pem \</span><br><span class="line">    --embed-certs=true \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context system:kube-controller-manager@kubernetes \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br></pre></td></tr></table></figure><h4 id="生成kube-scheduler证书"><a href="#生成kube-scheduler证书" class="headerlink" title="生成kube-scheduler证书"></a>生成kube-scheduler证书</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建证书签发请求文件</span></span><br><span class="line">cat &gt; scheduler-csr.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>签发kube-scheduler证书和密钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler</span><br></pre></td></tr></table></figure><p>生成kube-scheduler专用的 kubeconfig 配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">     --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">     --embed-certs=true \</span><br><span class="line">     --server=https://127.0.0.1:8443 \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials system:kube-scheduler \</span><br><span class="line">     --client-certificate=/etc/kubernetes/pki/scheduler.pem \</span><br><span class="line">     --client-key=/etc/kubernetes/pki/scheduler-key.pem \</span><br><span class="line">     --embed-certs=true \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context system:kube-scheduler@kubernetes \</span><br><span class="line">     --cluster=kubernetes \</span><br><span class="line">     --user=system:kube-scheduler \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context system:kube-scheduler@kubernetes \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br></pre></td></tr></table></figure><h4 id="生成admin证书"><a href="#生成admin证书" class="headerlink" title="生成admin证书"></a>生成admin证书</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建证书签发请求文件</span></span><br><span class="line">cat &gt; admin-csr.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;admin&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:masters&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>签发admin证书和密钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin</span><br></pre></td></tr></table></figure><p>生成admin专用的 kubeconfig 配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-cluster kubernetes     \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem     \</span><br><span class="line">  --embed-certs=true     \</span><br><span class="line">  --server=https://127.0.0.1:8443     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kubernetes-admin  \</span><br><span class="line">  --client-certificate=/etc/kubernetes/pki/admin.pem     \</span><br><span class="line">  --client-key=/etc/kubernetes/pki/admin-key.pem     \</span><br><span class="line">  --embed-certs=true     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context kubernetes-admin@kubernetes    \</span><br><span class="line">  --cluster=kubernetes     \</span><br><span class="line">  --user=kubernetes-admin     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context kubernetes-admin@kubernetes  --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br></pre></td></tr></table></figure><h4 id="生成kube-proxy证书"><a href="#生成kube-proxy证书" class="headerlink" title="生成kube-proxy证书"></a>生成kube-proxy证书</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建证书签发请求文件</span></span><br><span class="line">cat &gt; kube-proxy-csr.json  &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>签发 kube-proxy证书和密钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   kube-proxy-csr.json | cfssljson -bare /etc/kubernetes/pki/kube-proxy</span><br></pre></td></tr></table></figure><p>生成 kube-proxy专用的 kubeconfig 配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-cluster kubernetes     \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem     \</span><br><span class="line">  --embed-certs=true     \</span><br><span class="line">  --server=https://127.0.0.1:8443     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kube-proxy  \</span><br><span class="line">  --client-certificate=/etc/kubernetes/pki/kube-proxy.pem     \</span><br><span class="line">  --client-key=/etc/kubernetes/pki/kube-proxy-key.pem     \</span><br><span class="line">  --embed-certs=true     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context kube-proxy@kubernetes    \</span><br><span class="line">  --cluster=kubernetes     \</span><br><span class="line">  --user=kube-proxy     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context kube-proxy@kubernetes  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure><h4 id="创建ServiceAccount加密密钥"><a href="#创建ServiceAccount加密密钥" class="headerlink" title="创建ServiceAccount加密密钥"></a>创建ServiceAccount加密密钥</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out /etc/kubernetes/pki/sa.key 2048</span><br><span class="line">openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub</span><br></pre></td></tr></table></figure><h3 id="添加组件配置，启动服务"><a href="#添加组件配置，启动服务" class="headerlink" title="添加组件配置，启动服务"></a>添加组件配置，启动服务</h3><h4 id="ETCD组件（master节点）"><a href="#ETCD组件（master节点）" class="headerlink" title="ETCD组件（master节点）"></a>ETCD组件（master节点）</h4><p>（1）k8s-master01配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF </span><br><span class="line">name: &#x27;k8s-master01&#x27;</span><br><span class="line">data-dir: /var/lib/etcd</span><br><span class="line">wal-dir: /var/lib/etcd/wal</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: &#x27;https://192.168.0.111:2380&#x27;</span><br><span class="line">listen-client-urls: &#x27;https://192.168.0.111:2379,http://127.0.0.1:2379&#x27;</span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: &#x27;https://192.168.0.111:2380&#x27;</span><br><span class="line">advertise-client-urls: &#x27;https://192.168.0.111:2379&#x27;</span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: &#x27;proxy&#x27;</span><br><span class="line">discovery-proxy:</span><br><span class="line">discovery-srv:</span><br><span class="line">initial-cluster: &#x27;k8s-master01=https://192.168.0.111:2380,k8s-master02=https://192.168.0.112:2380,k8s-master03=https://192.168.0.113:2380&#x27;</span><br><span class="line">initial-cluster-token: &#x27;etcd-k8s-cluster&#x27;</span><br><span class="line">initial-cluster-state: &#x27;new&#x27;</span><br><span class="line">strict-reconfig-check: false</span><br><span class="line">enable-v2: true</span><br><span class="line">enable-pprof: true</span><br><span class="line">proxy: &#x27;off&#x27;</span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  peer-client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">debug: false</span><br><span class="line">log-package-levels:</span><br><span class="line">log-outputs: [default]</span><br><span class="line">force-new-cluster: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>（2）k8s-master02配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF </span><br><span class="line">name: &#x27;k8s-master02&#x27;</span><br><span class="line">data-dir: /var/lib/etcd</span><br><span class="line">wal-dir: /var/lib/etcd/wal</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: &#x27;https://192.168.0.112:2380&#x27;</span><br><span class="line">listen-client-urls: &#x27;https://192.168.0.112:2379,http://127.0.0.1:2379&#x27;</span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: &#x27;https://192.168.0.112:2380&#x27;</span><br><span class="line">advertise-client-urls: &#x27;https://192.168.0.112:2379&#x27;</span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: &#x27;proxy&#x27;</span><br><span class="line">discovery-proxy:</span><br><span class="line">discovery-srv:</span><br><span class="line">initial-cluster: &#x27;k8s-master01=https://192.168.0.111:2380,k8s-master02=https://192.168.0.112:2380,k8s-master03=https://192.168.0.113:2380&#x27;</span><br><span class="line">initial-cluster-token: &#x27;etcd-k8s-cluster&#x27;</span><br><span class="line">initial-cluster-state: &#x27;new&#x27;</span><br><span class="line">strict-reconfig-check: false</span><br><span class="line">enable-v2: true</span><br><span class="line">enable-pprof: true</span><br><span class="line">proxy: &#x27;off&#x27;</span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  peer-client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">debug: false</span><br><span class="line">log-package-levels:</span><br><span class="line">log-outputs: [default]</span><br><span class="line">force-new-cluster: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>（3）k8s-master03配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF </span><br><span class="line">name: &#x27;k8s-master03&#x27;</span><br><span class="line">data-dir: /var/lib/etcd</span><br><span class="line">wal-dir: /var/lib/etcd/wal</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: &#x27;https://192.168.0.113:2380&#x27;</span><br><span class="line">listen-client-urls: &#x27;https://192.168.0.113:2379,http://127.0.0.1:2379&#x27;</span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: &#x27;https://192.168.0.113:2380&#x27;</span><br><span class="line">advertise-client-urls: &#x27;https://192.168.0.113:2379&#x27;</span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: &#x27;proxy&#x27;</span><br><span class="line">discovery-proxy:</span><br><span class="line">discovery-srv:</span><br><span class="line">initial-cluster: &#x27;k8s-master01=https://192.168.0.111:2380,k8s-master02=https://192.168.0.112:2380,k8s-master03=https://192.168.0.113:2380&#x27;</span><br><span class="line">initial-cluster-token: &#x27;etcd-k8s-cluster&#x27;</span><br><span class="line">initial-cluster-state: &#x27;new&#x27;</span><br><span class="line">strict-reconfig-check: false</span><br><span class="line">enable-v2: true</span><br><span class="line">enable-pprof: true</span><br><span class="line">proxy: &#x27;off&#x27;</span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  peer-client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">debug: false</span><br><span class="line">log-package-levels:</span><br><span class="line">log-outputs: [default]</span><br><span class="line">force-new-cluster: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>（4）创建etcd服务启动配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Service</span><br><span class="line">Documentation=https://coreos.com/etcd/docs/latest/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">Alias=etcd3.service</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>（5）启动etcd服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/kubernetes/pki/etcd</span><br><span class="line">ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now etcd.service</span><br><span class="line">systemctl status etcd.service</span><br></pre></td></tr></table></figure><p>（6）etcd 集群的健康状态</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_API=3</span><br><span class="line">etcdctl --endpoints=&quot;192.168.0.111:2379,192.168.0.112:2379,192.168.0.113:2379&quot; --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table</span><br></pre></td></tr></table></figure><blockquote><p>+——————————+—————————+————-+————————-+————-+————+———————————-+———-+—————-+——————+—————-+——————+——————————+————+—————————————+—————————-+<br>| ENDPOINT | ID | VERSION | STORAGE VERSION | DB SIZE | IN USE | PERCENTAGE NOT IN USE | QUOTA | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS | DOWNGRADE TARGET VERSION | DOWNGRADE ENABLED |<br>+——————————+—————————+————-+————————-+————-+————+———————————-+———-+—————-+——————+—————-+——————+——————————+————+—————————————+—————————-+<br>| 192.168.0.111:2379 | 9c35553b47538310 | 3.6.4 | 3.6.0 | 20 kB | 16 kB | 20% | 0 B | <mark>true</mark> | false | 3 | 6 | 6 | | | false |<br>| 192.168.0.112:2379 | 545bae002651f913 | 3.6.4 | 3.6.0 | 20 kB | 16 kB | 20% | 0 B | false | false | 2 | 7 | 7 | | | false |<br>| 192.168.0.113:2379 | d7497b3a31d15f9e | 3.6.4 | 3.6.0 | 20 kB | 16 kB | 20% | 0 B | false | false | 2 | 7 | 7 | | | false |<br>+——————————+—————————+————-+————————-+————-+————+———————————-+———-+—————-+——————+—————-+——————+——————————+————+—————————————+—————————-+</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将etcd相关防火墙策略保存，防止重启后etcd服务无法启动</span></span><br><span class="line">service iptables save</span><br></pre></td></tr></table></figure><p>如果出现重启服务器后，etcd集群服务无法启动的情况。清空防火墙规则，启动etcd服务并保存策略即可。</p></blockquote><h4 id="安装Nginx配置高可用"><a href="#安装Nginx配置高可用" class="headerlink" title="安装Nginx配置高可用"></a>安装Nginx配置高可用</h4><p>（1）下载安装Nginx</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://nginx.org/download/nginx-1.28.0.tar.gz</span><br><span class="line">tar xvf nginx-1.28.0.tar.gz</span><br><span class="line">cd nginx-1.28.0</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编译安装，其中--with-stream为启用四层代理</span></span><br><span class="line">./configure --with-stream --without-http --without-http_uwsgi_module --without-http_scgi_module --without-http_fastcgi_module</span><br><span class="line">make &amp;&amp; make install </span><br></pre></td></tr></table></figure><p>（2）创建配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/local/nginx/conf/kube-nginx.conf &lt;&lt;EOF</span><br><span class="line">worker_processes 1;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line">stream &#123;</span><br><span class="line">    upstream backend &#123;</span><br><span class="line">    	least_conn;</span><br><span class="line">        hash $remote_addr consistent;</span><br><span class="line">        server 192.168.0.111:6443        max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 192.168.0.112:6443        max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 192.168.0.113:6443        max_fails=3 fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 127.0.0.1:8443;</span><br><span class="line">        proxy_connect_timeout 1s;</span><br><span class="line">        proxy_pass backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>（6）添加nignx服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/systemd/system/kube-nginx.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=kube-apiserver nginx proxy</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStartPre=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx -t</span><br><span class="line">ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx</span><br><span class="line">ExecReload=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx -s reload</span><br><span class="line">PrivateTmp=true</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>（7）启动服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now kube-nginx.service</span><br><span class="line">systemctl status kube-nginx.service</span><br></pre></td></tr></table></figure><h4 id="ApiServer组件"><a href="#ApiServer组件" class="headerlink" title="ApiServer组件"></a>ApiServer组件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">所有节点创建所需目录</span></span><br><span class="line">mkdir -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes</span><br></pre></td></tr></table></figure><p>（1）k8s-master01节点添加apiserver服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \\</span><br><span class="line">      --v=2  \\</span><br><span class="line">      --allow-privileged=true  \\</span><br><span class="line">      --bind-address=0.0.0.0  \\</span><br><span class="line">      --secure-port=6443  \\</span><br><span class="line">      --advertise-address=192.168.0.111 \\</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\</span><br><span class="line">      --service-node-port-range=30000-32767  \\</span><br><span class="line">      --etcd-servers=https://192.168.0.111:2379,https://192.168.0.112:2379,https://192.168.0.113:2379 \\</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\</span><br><span class="line">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \\</span><br><span class="line">      --authorization-mode=Node,RBAC  \\</span><br><span class="line">      --enable-bootstrap-token-auth=true  \\</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\</span><br><span class="line">      --requestheader-allowed-names=aggregator  \\</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \\</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\</span><br><span class="line">      --requestheader-username-headers=X-Remote-User \\</span><br><span class="line">      --enable-aggregator-routing=true</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>（2）k8s-master02节点添加apiserver服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \\</span><br><span class="line">      --v=2  \\</span><br><span class="line">      --allow-privileged=true  \\</span><br><span class="line">      --bind-address=0.0.0.0  \\</span><br><span class="line">      --secure-port=6443  \\</span><br><span class="line">      --advertise-address=192.168.0.112 \\</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\</span><br><span class="line">      --service-node-port-range=30000-32767  \\</span><br><span class="line">      --etcd-servers=https://192.168.0.111:2379,https://192.168.0.112:2379,https://192.168.0.113:2379 \\</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --kubelet-client-key=/etc/kuberntes/pki/apiserver-key.pem  \\</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\</span><br><span class="line">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \\</span><br><span class="line">      --authorization-mode=Node,RBAC  \\</span><br><span class="line">      --enable-bootstrap-token-auth=true  \\</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\</span><br><span class="line">      --requestheader-allowed-names=aggregator  \\</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \\</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\</span><br><span class="line">      --requestheader-username-headers=X-Remote-User \\</span><br><span class="line">      --enable-aggregator-routing=true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>（3）k8s-master03节点添加apiserver服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \\</span><br><span class="line">      --v=2  \\</span><br><span class="line">      --allow-privileged=true  \\</span><br><span class="line">      --bind-address=0.0.0.0  \\</span><br><span class="line">      --secure-port=6443  \\</span><br><span class="line">      --advertise-address=192.168.0.113 \\</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\</span><br><span class="line">      --service-node-port-range=30000-32767  \\</span><br><span class="line">      --etcd-servers=https://192.168.0.111:2379,https://192.168.0.112:2379,https://192.168.0.113:2379 \\</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\</span><br><span class="line">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \\</span><br><span class="line">      --authorization-mode=Node,RBAC  \\</span><br><span class="line">      --enable-bootstrap-token-auth=true  \\</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\</span><br><span class="line">      --requestheader-allowed-names=aggregator  \\</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \\</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\</span><br><span class="line">      --requestheader-username-headers=X-Remote-User \\</span><br><span class="line">      --enable-aggregator-routing=true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>（4）启动kube-apiserver服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl enable --now kube-apiserver</span><br><span class="line">systemctl status kube-apiserver</span><br></pre></td></tr></table></figure><h4 id="controller-manager组件"><a href="#controller-manager组件" class="headerlink" title="controller-manager组件"></a>controller-manager组件</h4><p>所有master节点添加controller-manager服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-controller-manager \\</span><br><span class="line">      --v=2 \\</span><br><span class="line">      --bind-address=0.0.0.0 \\</span><br><span class="line">      --root-ca-file=/etc/kubernetes/pki/ca.pem \\</span><br><span class="line">      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \\</span><br><span class="line">      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\</span><br><span class="line">      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \\</span><br><span class="line">      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \\</span><br><span class="line">      --leader-elect=true \\</span><br><span class="line">      --use-service-account-credentials=true \\</span><br><span class="line">      --node-monitor-grace-period=40s \\</span><br><span class="line">      --node-monitor-period=5s \\</span><br><span class="line">      --controllers=*,bootstrapsigner,tokencleaner \\</span><br><span class="line">      --allocate-node-cidrs=true \\</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112 \\</span><br><span class="line">      --cluster-cidr=172.16.0.0/12,fc00:2222::/112 \\</span><br><span class="line">      --node-cidr-mask-size-ipv4=24 \\</span><br><span class="line">      --node-cidr-mask-size-ipv6=120 \\</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem </span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>启动controller-manager服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now kube-controller-manager</span><br><span class="line">systemctl  status kube-controller-manager</span><br></pre></td></tr></table></figure><h4 id="kube-scheduler组件（master节点）"><a href="#kube-scheduler组件（master节点）" class="headerlink" title="kube-scheduler组件（master节点）"></a>kube-scheduler组件（master节点）</h4><p>所有master节点添加kube-scheduler服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-scheduler \\</span><br><span class="line">      --v=2 \\</span><br><span class="line">      --bind-address=0.0.0.0 \\</span><br><span class="line">      --leader-elect=true \\</span><br><span class="line">      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>启动kube-scheduler服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now kube-scheduler</span><br><span class="line">systemctl status kube-scheduler</span><br></pre></td></tr></table></figure><h4 id="TLS-Bootstrapping-配置（master01节点，用于自动签发证书）"><a href="#TLS-Bootstrapping-配置（master01节点，用于自动签发证书）" class="headerlink" title="TLS Bootstrapping 配置（master01节点，用于自动签发证书）"></a>TLS Bootstrapping 配置（master01节点，用于自动签发证书）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-cluster kubernetes     \</span><br><span class="line">--certificate-authority=/etc/kubernetes/pki/ca.pem     \</span><br><span class="line">--embed-certs=true     --server=https://127.0.0.1:8443     \</span><br><span class="line">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials tls-bootstrap-token-user     \</span><br><span class="line">--token=c8ad9c.2e4d610cf3e7426e \</span><br><span class="line">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context tls-bootstrap-token-user@kubernetes     \</span><br><span class="line">--cluster=kubernetes     \</span><br><span class="line">--user=tls-bootstrap-token-user     \</span><br><span class="line">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context tls-bootstrap-token-user@kubernetes     \</span><br><span class="line">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">token的位置在bootstrap.secret.yaml，如果修改的话到这个文件修改</span></span><br><span class="line">mkdir -p /root/.kube &amp;&amp; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config</span><br></pre></td></tr></table></figure><p>查看集群状态</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs</span><br></pre></td></tr></table></figure><p>创建bootstrap-secret授权文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; bootstrap-secret.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: bootstrap-token-c8ad9c</span><br><span class="line">  namespace: kube-system</span><br><span class="line">type: bootstrap.kubernetes.io/token</span><br><span class="line">stringData:</span><br><span class="line">  description: &quot;The default bootstrap token generated by &#x27;kubelet &#x27;.&quot;</span><br><span class="line">  token-id: &quot;c8ad9c&quot;</span><br><span class="line">  token-secret: &quot;2e4d610cf3e7426e&quot;</span><br><span class="line">  usage-bootstrap-authentication: &quot;true&quot;</span><br><span class="line">  usage-bootstrap-signing: &quot;true&quot;</span><br><span class="line">  auth-extra-groups:  system:bootstrappers:default-node-token,system:bootstrappers:worker,system:bootstrappers:ingress</span><br><span class="line"> </span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubelet-bootstrap</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:node-bootstrapper</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:bootstrappers:default-node-token</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: node-autoapprove-bootstrap</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:bootstrappers:default-node-token</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: node-autoapprove-certificate-rotation</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:nodes</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - nodes/proxy</span><br><span class="line">      - nodes/stats</span><br><span class="line">      - nodes/log</span><br><span class="line">      - nodes/spec</span><br><span class="line">      - nodes/metrics</span><br><span class="line">    verbs:</span><br><span class="line">      - &quot;*&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-apiserver</span><br><span class="line">  namespace: &quot;&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">subjects:</span><br><span class="line">  - apiGroup: rbac.authorization.k8s.io</span><br><span class="line">    kind: User</span><br><span class="line">    name: kube-apiserver</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>执行bootstrap-secret授权文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f bootstrap-secret.yaml</span><br></pre></td></tr></table></figure><p>将证书文件复制到其他节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/</span><br><span class="line">for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do ssh $NODE mkdir -p /etc/kubernetes/pki; for FILE in pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig kube-proxy.kubeconfig; do scp /etc/kubernetes/$FILE $NODE:/etc/kubernetes/$&#123;FILE&#125;; done; done</span><br></pre></td></tr></table></figure><h4 id="Kubelet组件（所有节点）"><a href="#Kubelet组件（所有节点）" class="headerlink" title="Kubelet组件（所有节点）"></a>Kubelet组件（所有节点）</h4><p>（1）添加kubelet服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network-online.target firewalld.service cri-docker.service docker.socket containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket containerd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \\</span><br><span class="line">    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\</span><br><span class="line">    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class="line">    --config=/etc/kubernetes/kubelet-conf.yml \\</span><br><span class="line">    --container-runtime-endpoint=unix:///run/cri-dockerd.sock  \\</span><br><span class="line">    --node-labels=node.kubernetes.io/node= </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>（2）创建kubelet配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/kubelet-conf.yml &lt;&lt;EOF</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/ca.pem</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">cgroupsPerQOS: true</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">containerLogMaxFiles: 5</span><br><span class="line">containerLogMaxSize: 10Mi</span><br><span class="line">contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">cpuCFSQuota: true</span><br><span class="line">cpuManagerPolicy: none</span><br><span class="line">cpuManagerReconcilePeriod: 10s</span><br><span class="line">enableControllerAttachDetach: true</span><br><span class="line">enableDebuggingHandlers: true</span><br><span class="line">enforceNodeAllocatable:</span><br><span class="line">- pods</span><br><span class="line">eventBurst: 10</span><br><span class="line">eventRecordQPS: 5</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">evictionPressureTransitionPeriod: 5m0s</span><br><span class="line">failSwapOn: true</span><br><span class="line">fileCheckFrequency: 20s</span><br><span class="line">hairpinMode: promiscuous-bridge</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 20s</span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">imageMinimumGCAge: 2m0s</span><br><span class="line">iptablesDropBit: 15</span><br><span class="line">iptablesMasqueradeBit: 14</span><br><span class="line">kubeAPIBurst: 10</span><br><span class="line">kubeAPIQPS: 5</span><br><span class="line">makeIPTablesUtilChains: true</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">nodeStatusUpdateFrequency: 10s</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">podPidsLimit: -1</span><br><span class="line">registryBurst: 10</span><br><span class="line">registryPullQPS: 5</span><br><span class="line">resolvConf: /etc/resolv.conf</span><br><span class="line">rotateCertificates: true</span><br><span class="line">runtimeRequestTimeout: 2m0s</span><br><span class="line">serializeImagePulls: true</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionIdleTimeout: 4h0m0s</span><br><span class="line">syncFrequency: 1m0s</span><br><span class="line">volumeStatsAggPeriod: 1m0s</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>（3）启动kubelet服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now kubelet</span><br><span class="line">systemctl status kubelet</span><br></pre></td></tr></table></figure><h4 id="kube-proxy组件（所有节点）"><a href="#kube-proxy组件（所有节点）" class="headerlink" title="kube-proxy组件（所有节点）"></a>kube-proxy组件（所有节点）</h4><p>（1）将证书发送至其他节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do scp /etc/kubernetes/kube-proxy.kubeconfig $NODE:/etc/kubernetes/kube-proxy.kubeconfig; done</span><br></pre></td></tr></table></figure><p>（2）添加kube-proxy服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube Proxy</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-proxy \\</span><br><span class="line">  --config=/etc/kubernetes/kube-proxy.yaml \\</span><br><span class="line">  --cluster-cidr=172.16.0.0/12,fc00:2222::/112 \\</span><br><span class="line">  --v=2</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>（3）创建kube-proxy配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/kube-proxy.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">clientConnection:</span><br><span class="line">  acceptContentTypes: &quot;&quot;</span><br><span class="line">  burst: 10</span><br><span class="line">  contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">  qps: 5</span><br><span class="line">clusterCIDR: 172.16.0.0/12,fc00:2222::/112</span><br><span class="line">configSyncPeriod: 15m0s</span><br><span class="line">conntrack:</span><br><span class="line">  max: null</span><br><span class="line">  maxPerCore: 32768</span><br><span class="line">  min: 131072</span><br><span class="line">  tcpCloseWaitTimeout: 1h0m0s</span><br><span class="line">  tcpEstablishedTimeout: 24h0m0s</span><br><span class="line">enableProfiling: false</span><br><span class="line">healthzBindAddress: 0.0.0.0:10256</span><br><span class="line">hostnameOverride: &quot;&quot;</span><br><span class="line">iptables:</span><br><span class="line">  masqueradeAll: false</span><br><span class="line">  masqueradeBit: 14</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">ipvs:</span><br><span class="line">  masqueradeAll: true</span><br><span class="line">  minSyncPeriod: 5s</span><br><span class="line">  scheduler: &quot;rr&quot;</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: 127.0.0.1:10249</span><br><span class="line">mode: &quot;ipvs&quot;</span><br><span class="line">nodePortAddresses: null</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">portRange: &quot;&quot;</span><br><span class="line">udpIdleTimeout: 250ms</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>（4）启动kube-proxy服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now kube-proxy.service</span><br><span class="line">systemctl status kube-proxy.service</span><br></pre></td></tr></table></figure><h3 id="安装Calico网络插件"><a href="#安装Calico网络插件" class="headerlink" title="安装Calico网络插件"></a>安装Calico网络插件</h3><p>（1）下载安装Calico插件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget https://hub.gitmirror.com/https://raw.githubusercontent.com/projectcalico/calico/v3.30.2/manifests/calico.yaml </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">取消注释并修改pod网端</span></span><br><span class="line">- name: CALICO_IPV4POOL_CIDR</span><br><span class="line">   value: &quot;172.16.0.0/12&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">更改容器镜像源</span></span><br><span class="line">sed -i &quot;s#docker.io/calico/#m.daocloud.io/docker.io/calico/#g&quot; calico.yaml</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">执行安装</span></span><br><span class="line">kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure><h3 id="安装CoreDNS"><a href="#安装CoreDNS" class="headerlink" title="安装CoreDNS"></a>安装CoreDNS</h3><p>（1）下载安装Helm</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://get.helm.sh/helm-v3.18.4-linux-amd64.tar.gz</span><br><span class="line">tar -zxvf helm-v3.18.4-linux-amd64.tar.gz</span><br><span class="line">cp -a linux-amd64/helm /usr/local/bin/</span><br><span class="line">chmod a+x /usr/local/bin/helm</span><br><span class="line">helm version</span><br></pre></td></tr></table></figure><p>（2）使用Helm安装CoreDNS</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm repo add coredns https://coredns.github.io/helm</span><br><span class="line">helm pull coredns/coredns</span><br><span class="line">tar xvf coredns-*.tgz</span><br><span class="line">cd coredns/</span><br></pre></td></tr></table></figure><p>（3）修改values.yml文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">clusterIP: &quot;10.96.0.10&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">更换镜像源</span></span><br><span class="line">sed -i  &#x27;s|coredns/coredns|m.daocloud.io/docker.io/coredns/coredns|g&#x27; values.yaml</span><br><span class="line"> sed -i &quot;s|registry.k8s.io/cpa/cluster-proportional-autoscaler|m.daocloud.io/registry.k8s.io/cpa/cluster-proportional-autoscaler|g&quot; values.yaml</span><br></pre></td></tr></table></figure><p>（4）安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm install  coredns ./ -n kube-system</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看安装情况</span></span><br><span class="line">kubectl get pod -n kube-system</span><br></pre></td></tr></table></figure><h3 id="安装Metrics-Server"><a href="#安装Metrics-Server" class="headerlink" title="安装Metrics Server"></a>安装Metrics Server</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">wget https://hub.gitmirror.com/https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.8.0/components.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改配置</span></span><br><span class="line">      - args:</span><br><span class="line">        - --cert-dir=/tmp</span><br><span class="line">        - --secure-port=10250</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span><br><span class="line">        - --kubelet-use-node-status-port</span><br><span class="line">        - --metric-resolution=15s</span><br><span class="line">        - --kubelet-insecure-tls</span><br><span class="line">        - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem</span><br><span class="line">        - --requestheader-username-headers=X-Remote-User</span><br><span class="line">        - --requestheader-group-headers=X-Remote-Group</span><br><span class="line">        - --requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /tmp</span><br><span class="line">          name: tmp-dir</span><br><span class="line">        - name: ca-ssl</span><br><span class="line">          mountPath: /etc/kubernetes/pki</span><br><span class="line"></span><br><span class="line">          </span><br><span class="line"></span><br><span class="line">      volumes:</span><br><span class="line">      - emptyDir: &#123;&#125;</span><br><span class="line">        name: tmp-dir</span><br><span class="line">      - name: ca-ssl</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/kubernetes/pki</span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改镜像源</span></span><br><span class="line">sed -i &quot;s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g&quot; components.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">执行部署</span></span><br><span class="line">kubectl apply -f components.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">验证</span></span><br><span class="line"> kubectl top pod -A</span><br></pre></td></tr></table></figure><h3 id="设置各节点角色标签和污点"><a href="#设置各节点角色标签和污点" class="headerlink" title="设置各节点角色标签和污点"></a>设置各节点角色标签和污点</h3><p>（1）设置master节点污点</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node k8s-master01 node-role.kubernetes.io/master:NoSchedule</span><br><span class="line">kubectl taint node k8s-master02 node-role.kubernetes.io/master:NoSchedule</span><br><span class="line">kubectl taint node k8s-master03 node-role.kubernetes.io/master:NoSchedule</span><br></pre></td></tr></table></figure><p>（2）设置各节点角色标签</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">k8s-master01</span></span><br><span class="line">kubectl label nodes k8s-master01 node-role.kubernetes.io/master=</span><br><span class="line">kubectl label nodes k8s-master01 node-role.kubernetes.io/control-plane=</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">k8s-master02</span></span><br><span class="line">kubectl label nodes k8s-master02 node-role.kubernetes.io/master=</span><br><span class="line">kubectl label nodes k8s-master02 node-role.kubernetes.io/control-plane=</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">k8s-master03</span></span><br><span class="line">kubectl label nodes k8s-master03 node-role.kubernetes.io/master=</span><br><span class="line">kubectl label nodes k8s-master03 node-role.kubernetes.io/control-plane=</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">k8s-node01</span></span><br><span class="line">kubectl label nodes k8s-node01 node-role.kubernetes.io/worker=</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">k8s-node02</span></span><br><span class="line">kubectl label nodes k8s-node02 node-role.kubernetes.io/worker=</span><br></pre></td></tr></table></figure><h3 id="设置命令补全"><a href="#设置命令补全" class="headerlink" title="设置命令补全"></a>设置命令补全</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install bash-completion -y</span><br><span class="line">source /usr/share/bash-completion/bash_completion</span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure><h3 id="验证高可用"><a href="#验证高可用" class="headerlink" title="验证高可用"></a>验证高可用</h3><p>（1）验证etcd集群高可用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">验证etcd集群高可用</span></span><br><span class="line">export ETCDCTL_API=3</span><br><span class="line">etcdctl --endpoints=&quot;192.168.0.113:2379,192.168.0.112:2379,192.168.0.111:2379&quot; --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table</span><br></pre></td></tr></table></figure><p>（2）使用 etcdhelper 查询 etcd 中 k8s 的资源数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">拉取etcdhelper源码文件</span></span><br><span class="line">git clone --depth 1 https://hub.gitmirror.com/https://github.com/openshift/origin.git</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载依赖软件</span></span><br><span class="line">yum install -y go</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">构建etcdhelper执行程序</span></span><br><span class="line">cd origin/tools/etcdhelper</span><br><span class="line">go build etcdhelper.go</span><br><span class="line">mv etcdhelper /usr/local/bin/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设定参数别名</span></span><br><span class="line">echo &#x27;alias ectl=&quot;etcdhelper -endpoint https://192.168.0.111:2379 -cacert /etc/etcd/ssl/etcd-ca.pem -key /etc/etcd/ssl/etcd-key.pem -cert /etc/etcd/ssl/etcd.pem&quot;&#x27; &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">执行配置生效</span></span><br><span class="line">source ~/.bashrc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看etcd数据</span></span><br><span class="line">ectl ls</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前的 schedule 主节点</span></span><br><span class="line">ectl get /registry/leases/kube-system/kube-scheduler</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前的 controllermanager 主节点</span></span><br><span class="line">ectl get /registry/leases/kube-system/kube-controller-manager</span><br></pre></td></tr></table></figure><h3 id="部署deployment验证"><a href="#部署deployment验证" class="headerlink" title="部署deployment验证"></a>部署deployment验证</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vi</span> <span class="string">test.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">6</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">test01</span>  </span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">test01</span> </span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test01</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span>  </span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test02</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">test02</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">test02</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeName:</span> <span class="string">k8s-node02</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test02</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span>  </span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>  </span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">test01</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span>       </span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span>  </span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test02</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>  </span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">test02</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span>       </span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span> </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">#部署</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">test.yml</span></span><br><span class="line"><span class="comment">#查看</span></span><br><span class="line"><span class="string">kubectl</span>  <span class="string">get</span> <span class="string">pod,svc,deployments</span> <span class="string">-o</span> <span class="string">wide</span></span><br><span class="line"><span class="comment">#在浏览器访问查看nginx访问情况</span></span><br></pre></td></tr></table></figure><blockquote><p>本篇知识来源于B站视频BV1PbeueyE8V</p></blockquote></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者:</span> <span class="post-copyright-info"><a href="https://yyg.js.cool/">云野阁</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接:</span> <span class="post-copyright-info"><a href="https://yyg.js.cool/yyg/986299a9/">https://yyg.js.cool/yyg/986299a9/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://yyg.js.cool" target="_blank">云野阁</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%BF%90%E7%BB%B4/">运维</a><a class="post-meta__tags" href="/tags/k8s/">k8s</a><a class="post-meta__tags" href="/tags/HELM/">HELM</a><a class="post-meta__tags" href="/tags/%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/">知识梳理</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8k8s%E9%9B%86%E7%BE%A4/">二进制高可用k8s集群</a></div><div class="post-share"><div class="social-share" data-image="https://api.mmp.cc/api/pcwallpaper?category=cool&amp;type=jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/butterfly-extsrc/1.1.4/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://s4.zstatic.net/ajax/libs/butterfly-extsrc/1.1.4/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/yyg/4789a872/" title="私有化部署DeepSeek"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgapi.cn/api.php?fl=fengjing&amp;gs=images" onerror='onerror=null,src="/img/icon.png"' alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">私有化部署DeepSeek</div></div><div class="info-2"><div class="info-item-1">前言在linux环境下，使用docker部署ollama+deepseek-r1:1.5b+open-webui，实现私有化部署DeepSeek。 部署过程安装docker使用脚本安装docker、docker-compose 1ba...</div></div></div></a><a class="pagination-related" href="/yyg/2eca17c7/" title="Gitalk自动创建评论Issues"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://unsplash.it/1600/900?random" onerror='onerror=null,src="/img/icon.png"' alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Gitalk自动创建评论Issues</div></div><div class="info-2"><div class="info-item-1">博客加入Gitalk评论后，需要访问相应页面，才在存放评论的仓库创建Issues。本文通过脚本自动访问文章页面完成Gitalk自动创建评论Issues。脚本自attson/hexo-gitalk-init: Hexo gitalk 极...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related no-desc" href="/yyg/f5a7a3df/" title="Kubernetes知识梳理"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://random-img.pupper.cn/api" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-24</div><div class="info-item-2">Kubernetes知识梳理</div></div></div></a><a class="pagination-related" href="/yyg/dc35290c/" title="Kubernetes知识梳理-核心组件"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://t.alcy.cc/fj" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-17</div><div class="info-item-2">Kubernetes知识梳理-核心组件</div></div><div class="info-2"><div class="info-item-1">pod在kubernetes中基本所有资源的一级属性都是一样的，主要包含5部分： apiVersion &lt;string&gt; 版本，由kubernetes内部定义，版本号必须可以用kubectl api-versions查询...</div></div></div></a><a class="pagination-related no-desc" href="/yyg/5c56de6f/" title="docker知识梳理"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgapi.cn/api.php?fl=fengjing&gs=images" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-24</div><div class="info-item-2">docker知识梳理</div></div></div></a><a class="pagination-related" href="/yyg/3b57c0c6/" title="docker容器日志配置管理"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api.mmp.cc/api/pcwallpaper?category=cool&type=jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-07</div><div class="info-item-2">docker容器日志配置管理</div></div><div class="info-2"><div class="info-item-1">运行的项目容器突然就停了，查看容器日志发现磁盘空间不足，导致容器没法运行了。 Error response from daemon: Cannot restart container docker-p: mkdir /home/do...</div></div></div></a><a class="pagination-related no-desc" href="/yyg/d0a69eae/" title="shell脚本"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://bing.img.run/rand_uhd.php" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-23</div><div class="info-item-2">shell脚本</div></div></div></a><a class="pagination-related" href="/yyg/fd02fe22/" title="Slim缩小容器镜像大小"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgapi.cn/api.php?fl=fengjing&gs=images" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-05</div><div class="info-item-2">Slim缩小容器镜像大小</div></div><div class="info-2"><div class="info-item-1">前言 🔜Slim🔚 GitHub - slimtoolkit/slim： Slim（toolkit）：不要更改容器镜像中的任何内容，并将其缩小多达 30 倍（对于编译语言...</div></div></div></a></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div><div class="comment-switch"><span class="first-comment">Giscus</span><span id="switch-btn"></span><span class="second-comment">Utterances</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div><div><div id="utterances-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/icon.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info-name">云野阁</div><div class="author-info-description">闲云野鹤，八方逍遥</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">62</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">109</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/MarsperL" target="_blank" title="Github"><i class="fab fa-github" style="color:#24292e"></i></a><a class="social-icon" href="mailto:eXlnbGlAZm94bWFpbC5jb20=" target="_blank" title="Email"><i class="fas fa-envelope" style="color:#4a7dbe"></i></a><a class="social-icon" href="/rss2.xml" target="_blank"><i class="fas fa-rss"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C"><span class="toc-number">1.</span> <span class="toc-text">网络</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service"><span class="toc-number">2.</span> <span class="toc-text">Service</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Secret"><span class="toc-number">3.</span> <span class="toc-text">Secret</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Downward-API"><span class="toc-number">4.</span> <span class="toc-text">Downward API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HELM"><span class="toc-number">5.</span> <span class="toc-text">HELM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85"><span class="toc-number">5.1.</span> <span class="toc-text">下载安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85chart%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.2.</span> <span class="toc-text">安装chart示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7%E5%92%8C%E5%9B%9E%E6%BB%9A"><span class="toc-number">5.3.</span> <span class="toc-text">升级和回滚</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89chart%E5%8C%85"><span class="toc-number">5.4.</span> <span class="toc-text">创建自定义chart包</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8Kubernetes%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="toc-number">6.</span> <span class="toc-text">二进制高可用Kubernetes集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">6.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="toc-number">6.2.</span> <span class="toc-text">集群架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">6.3.</span> <span class="toc-text">环境初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85docker"><span class="toc-number">6.4.</span> <span class="toc-text">安装docker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85cri-dockerd"><span class="toc-number">6.5.</span> <span class="toc-text">安装cri-dockerd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85etcd%E9%9B%86%E7%BE%A4%EF%BC%88master%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">6.6.</span> <span class="toc-text">安装etcd集群（master节点）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Kubernetes%E9%9B%86%E7%BE%A4"><span class="toc-number">6.7.</span> <span class="toc-text">安装Kubernetes集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E7%9B%B8%E5%85%B3%E8%AF%81%E4%B9%A6%EF%BC%88master%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">6.8.</span> <span class="toc-text">生成相关证书（master节点）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85cfssl%E8%AF%81%E4%B9%A6%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7"><span class="toc-number">6.8.1.</span> <span class="toc-text">安装cfssl证书管理工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90ETCD%E8%AF%81%E4%B9%A6"><span class="toc-number">6.8.2.</span> <span class="toc-text">生成ETCD证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90Kubernetes%E8%AF%81%E4%B9%A6"><span class="toc-number">6.8.3.</span> <span class="toc-text">生成Kubernetes证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90ApiServer%E8%AF%81%E4%B9%A6"><span class="toc-number">6.8.4.</span> <span class="toc-text">生成ApiServer证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90ApiServer%E8%81%9A%E5%90%88%E8%AF%81%E4%B9%A6"><span class="toc-number">6.8.5.</span> <span class="toc-text">生成ApiServer聚合证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90ApiServer%E8%81%9A%E5%90%88%E8%AF%81%E4%B9%A6%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%81%E4%B9%A6"><span class="toc-number">6.8.6.</span> <span class="toc-text">生成ApiServer聚合证书的客户端证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90controller-manager%E8%AF%81%E4%B9%A6"><span class="toc-number">6.8.7.</span> <span class="toc-text">生成controller-manager证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90kube-scheduler%E8%AF%81%E4%B9%A6"><span class="toc-number">6.8.8.</span> <span class="toc-text">生成kube-scheduler证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90admin%E8%AF%81%E4%B9%A6"><span class="toc-number">6.8.9.</span> <span class="toc-text">生成admin证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90kube-proxy%E8%AF%81%E4%B9%A6"><span class="toc-number">6.8.10.</span> <span class="toc-text">生成kube-proxy证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAServiceAccount%E5%8A%A0%E5%AF%86%E5%AF%86%E9%92%A5"><span class="toc-number">6.8.11.</span> <span class="toc-text">创建ServiceAccount加密密钥</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%BB%84%E4%BB%B6%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">6.9.</span> <span class="toc-text">添加组件配置，启动服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ETCD%E7%BB%84%E4%BB%B6%EF%BC%88master%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">6.9.1.</span> <span class="toc-text">ETCD组件（master节点）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Nginx%E9%85%8D%E7%BD%AE%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">6.9.2.</span> <span class="toc-text">安装Nginx配置高可用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ApiServer%E7%BB%84%E4%BB%B6"><span class="toc-number">6.9.3.</span> <span class="toc-text">ApiServer组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#controller-manager%E7%BB%84%E4%BB%B6"><span class="toc-number">6.9.4.</span> <span class="toc-text">controller-manager组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kube-scheduler%E7%BB%84%E4%BB%B6%EF%BC%88master%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">6.9.5.</span> <span class="toc-text">kube-scheduler组件（master节点）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TLS-Bootstrapping-%E9%85%8D%E7%BD%AE%EF%BC%88master01%E8%8A%82%E7%82%B9%EF%BC%8C%E7%94%A8%E4%BA%8E%E8%87%AA%E5%8A%A8%E7%AD%BE%E5%8F%91%E8%AF%81%E4%B9%A6%EF%BC%89"><span class="toc-number">6.9.6.</span> <span class="toc-text">TLS Bootstrapping 配置（master01节点，用于自动签发证书）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kubelet%E7%BB%84%E4%BB%B6%EF%BC%88%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">6.9.7.</span> <span class="toc-text">Kubelet组件（所有节点）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kube-proxy%E7%BB%84%E4%BB%B6%EF%BC%88%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">6.9.8.</span> <span class="toc-text">kube-proxy组件（所有节点）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6"><span class="toc-number">6.10.</span> <span class="toc-text">安装Calico网络插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85CoreDNS"><span class="toc-number">6.11.</span> <span class="toc-text">安装CoreDNS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Metrics-Server"><span class="toc-number">6.12.</span> <span class="toc-text">安装Metrics Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%90%84%E8%8A%82%E7%82%B9%E8%A7%92%E8%89%B2%E6%A0%87%E7%AD%BE%E5%92%8C%E6%B1%A1%E7%82%B9"><span class="toc-number">6.13.</span> <span class="toc-text">设置各节点角色标签和污点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%91%BD%E4%BB%A4%E8%A1%A5%E5%85%A8"><span class="toc-number">6.14.</span> <span class="toc-text">设置命令补全</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">6.15.</span> <span class="toc-text">验证高可用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2deployment%E9%AA%8C%E8%AF%81"><span class="toc-number">6.16.</span> <span class="toc-text">部署deployment验证</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/yyg/2eca17c7/" title="Gitalk自动创建评论Issues"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://unsplash.it/1600/900?random" onerror='this.onerror=null,this.src="/img/icon.png"' alt="Gitalk自动创建评论Issues"></a><div class="content"><a class="title" href="/yyg/2eca17c7/" title="Gitalk自动创建评论Issues">Gitalk自动创建评论Issues</a><time datetime="2025-10-08T14:06:07.000Z" title="发表于 2025-10-08 22:06:07">2025-10-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/yyg/986299a9/" title="k8s知识梳理--进阶"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api.mmp.cc/api/pcwallpaper?category=cool&amp;type=jpg" onerror='this.onerror=null,this.src="/img/icon.png"' alt="k8s知识梳理--进阶"></a><div class="content"><a class="title" href="/yyg/986299a9/" title="k8s知识梳理--进阶">k8s知识梳理--进阶</a><time datetime="2025-08-22T10:17:22.000Z" title="发表于 2025-08-22 18:17:22">2025-08-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/yyg/4789a872/" title="私有化部署DeepSeek"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgapi.cn/api.php?fl=fengjing&amp;gs=images" onerror='this.onerror=null,this.src="/img/icon.png"' alt="私有化部署DeepSeek"></a><div class="content"><a class="title" href="/yyg/4789a872/" title="私有化部署DeepSeek">私有化部署DeepSeek</a><time datetime="2025-08-16T09:12:50.000Z" title="发表于 2025-08-16 17:12:50">2025-08-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/yyg/37098f8c/" title="使用GitHub Actions实现Hexo博客的自动化发布"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://wp.upx8.com/api.php?content=风景" onerror='this.onerror=null,this.src="/img/icon.png"' alt="使用GitHub Actions实现Hexo博客的自动化发布"></a><div class="content"><a class="title" href="/yyg/37098f8c/" title="使用GitHub Actions实现Hexo博客的自动化发布">使用GitHub Actions实现Hexo博客的自动化发布</a><time datetime="2025-07-06T13:43:23.000Z" title="发表于 2025-07-06 21:43:23">2025-07-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/yyg/9e02bef8/" title="观影感受--雄狮少年2"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/img01.png" onerror='this.onerror=null,this.src="/img/icon.png"' alt="观影感受--雄狮少年2"></a><div class="content"><a class="title" href="/yyg/9e02bef8/" title="观影感受--雄狮少年2">观影感受--雄狮少年2</a><time datetime="2025-06-04T03:35:51.000Z" title="发表于 2025-06-04 11:35:51">2025-06-04</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2024 - 2025 By 云野阁</span></div><div class="footer_custom_text"><div id="runtime"></div>世界上只有一种真正的英雄主义，那就是看清生活的真相之后，依然热爱生活</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button id="refresh-cache" type="button" title="刷新缓存" onclick="refreshCache()"><i class="fas fa-refresh fa-spin"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight,500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src="/js/utils.js?v=5.5.1"></script><script src="/js/main.js?v=5.5.1"></script><script src="https://s4.zstatic.net/ajax/libs/fancyapps-ui/5.0.36/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://s4.zstatic.net/ajax/libs/vanilla-lazyload/19.1.3/lazyload.iife.min.js"></script><div class="js-pjax"><script>(()=>{const e=()=>{(()=>{const e=document.querySelectorAll("pre > code.mermaid");0!==e.length&&e.forEach(e=>{const t=document.createElement("pre");t.className="mermaid-src",t.hidden=!0,t.textContent=e.textContent;const n=document.createElement("div");n.className="mermaid-wrap",n.appendChild(t),e.parentNode.replaceWith(n)})})();const e=document.querySelectorAll("#article-container .mermaid-wrap");if(0===e.length)return;const t=()=>(e=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";e.forEach((e,n)=>{const d=e.firstElementChild,a=`mermaid-${n}`,r=`%%{init:{ 'theme':'${t}'}}%%\n`+d.textContent,m=mermaid.render(a,r),o=e=>{d.insertAdjacentHTML("afterend",e)};"string"==typeof m?o(m):m.then(({svg:e})=>o(e))})})(e);btf.addGlobalFn("themeChange",t,"mermaid"),window.loadMermaid?t():btf.getScript("https://cdn.jsdelivr.net/npm/mermaid@11.12.0/dist/mermaid.min.js").then(t)};btf.addGlobalFn("encrypt",e,"mermaid"),window.pjax?e():document.addEventListener("DOMContentLoaded",e)})()</script><script>(()=>{const t="shuoshuo"===GLOBAL_CONFIG_SITE.pageType,e={"data-lang":"zh-CN","data-input-position":"top","data-loading":"lazy"},a=t=>"dark"===t?"noborder_dark":"noborder_light",s=(s=document,o)=>{const n=t?{"data-mapping":"specific","data-term":o}:{"data-mapping":e&&e["data-mapping"]||"pathname"},d=(t=>{const e=document.createElement("script");return Object.entries(t).forEach(([t,a])=>{e.setAttribute(t,a)}),e})({src:"https://giscus.app/client.js","data-repo":"MarsperL/MarsperL.github.io","data-repo-id":"R_kgDOHV6bsQ","data-category-id":"DIC_kwDOHV6bsc4Cd54m","data-theme":a(document.documentElement.getAttribute("data-theme")),"data-reactions-enabled":"1",crossorigin:"anonymous",async:!0,...e,...n});s.querySelector("#giscus-wrap").appendChild(d),t&&(window.shuoshuoComment.destroyGiscus=()=>{s.children.length&&(s.innerHTML="",s.classList.add("no-comment"))})};btf.addGlobalFn("themeChange",t=>{const e=document.querySelector("#giscus-wrap iframe");if(e){const s={giscus:{setConfig:{theme:a(t)}}};e.contentWindow.postMessage(s,"https://giscus.app")}},"giscus"),t?window.shuoshuoComment={loadComment:s}:s()})()</script><script>(()=>{const e="shuoshuo"===GLOBAL_CONFIG_SITE.pageType,t={label:"Utterances"},n=e=>"dark"===e?"dark-blue":"github-light",s=(s=document,r)=>{e&&(window.shuoshuoComment.destroyUtterances=()=>{s.children.length&&(s.innerHTML="",s.classList.add("no-comment"))});const o={src:"https://utteranc.es/client.js",repo:"MarsperL/yygyws",theme:n(document.documentElement.getAttribute("data-theme")),crossorigin:"anonymous",async:!0,...t,"issue-term":e?r:t&&t["issue-term"]||"title"},c=document.createElement("script");Object.entries(o).forEach(([e,t])=>c.setAttribute(e,t)),s.querySelector("#utterances-wrap").appendChild(c)};btf.addGlobalFn("themeChange",e=>{const t=document.querySelector("#utterances-wrap iframe");if(t){const s={type:"set-theme",theme:n(e)};t.contentWindow.postMessage(s,"https://utteranc.es")}},"utterances"),e?window.loadOtherComment=s:s()})()</script></div><script src="/js/parts.js"></script><script async src="/js/refresh.js"></script><script src="/js/background.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"></div><hr><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.1"></script></div></div><script data-pjax>function butterfly_swiper_injector_config(){var a=document.getElementById("recent-posts");console.log("已挂载butterfly_swiper"),a.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="yyg/e102aa73/" alt=""><img width="48" height="48" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://bing.img.run/rand_uhd.php" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-07-15</span><a class="blog-slider__title" href="yyg/e102aa73/" alt="">Hexo-Butterfly美化教程-[1]基础环境</a><div class="blog-slider__text">点击查看置顶文章啦~~~</div><a class="blog-slider__button" href="yyg/e102aa73/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="yyg/80ffa402/" alt=""><img width="48" height="48" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://random-img.pupper.cn/api" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-03-10</span><a class="blog-slider__title" href="yyg/80ffa402/" alt="">Hexo-Butterfly美化教程-[2]Butterfly主题安装</a><div class="blog-slider__text">点击查看置顶文章啦~~~</div><a class="blog-slider__button" href="yyg/80ffa402/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="yyg/b2261cee/" alt=""><img width="48" height="48" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://wp.upx8.com/api.php?content=风景" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-05-19</span><a class="blog-slider__title" href="yyg/b2261cee/" alt="">Hexo-Butterfly美化教程-[3]建主要页面</a><div class="blog-slider__text">点击查看置顶文章啦~~~</div><a class="blog-slider__button" href="yyg/b2261cee/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="yyg/8a5ee3aa/" alt=""><img width="48" height="48" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://tu.ltyuanfang.cn/api/fengjing.php" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-05-19</span><a class="blog-slider__title" href="yyg/8a5ee3aa/" alt="">Hexo-Butterfly美化教程-[4]修改配置文件</a><div class="blog-slider__text">点击查看置顶文章啦~~~</div><a class="blog-slider__button" href="yyg/8a5ee3aa/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="yyg/23010111/" alt=""><img width="48" height="48" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://www.yumus.cn/api/?target=img&amp;brand=360&amp;type=3" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-05-19</span><a class="blog-slider__title" href="yyg/23010111/" alt="">Hexo-Butterfly美化教程-[5]安装常用插件</a><div class="blog-slider__text">点击查看置顶文章啦~~~</div><a class="blog-slider__button" href="yyg/23010111/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="yyg/5986cad/" alt=""><img width="48" height="48" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://t.alcy.cc/fj" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-05-21</span><a class="blog-slider__title" href="yyg/5986cad/" alt="">Hexo-Butterfly美化教程-[6]开启博客评论</a><div class="blog-slider__text">点击查看置顶文章啦~~~</div><a class="blog-slider__button" href="yyg/5986cad/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="yyg/5baeb6c6/" alt=""><img width="48" height="48" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api.mmp.cc/api/pcwallpaper?category=cool&amp;type=jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-05-20</span><a class="blog-slider__title" href="yyg/5baeb6c6/" alt="">Hexo-Butterfly美化教程-[7]功能魔改(源码方式)</a><div class="blog-slider__text">点击查看置顶文章啦~~~</div><a class="blog-slider__button" href="yyg/5baeb6c6/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="yyg/5f747cff/" alt=""><img width="48" height="48" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://tu.ltyuanfang.cn/api/fengjing.php" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-05-23</span><a class="blog-slider__title" href="yyg/5f747cff/" alt="">Hexo-Butterfly美化教程-[8]随鼠标变幻的动态粒子线条背景</a><div class="blog-slider__text">点击查看置顶文章啦~~~</div><a class="blog-slider__button" href="yyg/5f747cff/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="yyg/ca46b09/" alt=""><img width="48" height="48" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://imgapi.cn/api.php?fl=fengjing&amp;gs=images" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-08-07</span><a class="blog-slider__title" href="yyg/ca46b09/" alt="">Hexo-Butterfly美化教程-[9]繁沙</a><div class="blog-slider__text">点击查看置顶文章啦~~~</div><a class="blog-slider__button" href="yyg/ca46b09/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="yyg/5ea27f40/" alt=""><img width="48" height="48" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://api.mmp.cc/api/pcwallpaper?category=cool&amp;type=jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-08-26</span><a class="blog-slider__title" href="yyg/5ea27f40/" alt="">在Github上使用OsmosFeed搭建在线RSS阅读器（无需服务器）</a><div class="blog-slider__text">点击查看置顶文章啦~~~</div><a class="blog-slider__button" href="yyg/5ea27f40/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="yyg/37098f8c/" alt=""><img width="48" height="48" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://wp.upx8.com/api.php?content=风景" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-07-06</span><a class="blog-slider__title" href="yyg/37098f8c/" alt="">使用GitHub Actions实现Hexo博客的自动化发布</a><div class="blog-slider__text">点击查看置顶文章啦~~~</div><a class="blog-slider__button" href="yyg/37098f8c/" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>')}for(var elist="undefined".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_swiper_injector_config()</script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script></body></html>